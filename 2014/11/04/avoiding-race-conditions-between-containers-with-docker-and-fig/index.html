<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Avoiding race conditions between containers with docker and fig | Chmouel's blog</title><meta name=keywords content="Docker"><meta name=description content="I have been playing with docker quite a lot lately. The advantage for me is to be able to run functional tests easily and be able to document how deployment should be done of my software as a developer for my endusers (i.e: operators/admins).
The advantage of this method is probably an article of its own which I won&rsquo;t dig into today but just to give a tip for the existing users of fig/docker"><meta name=author content><link rel=canonical href=https://blog.chmouel.com/2014/11/04/avoiding-race-conditions-between-containers-with-docker-and-fig/><link crossorigin=anonymous href=/assets/css/stylesheet.min.5a5d567b690246c4eb15b9f0c3d47bef28df71173b90a626c03708a628d3193d.css integrity="sha256-Wl1We2kCRsTrFbnww9R77yjfcRc7kKYmwDcIpijTGT0=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.chmouel.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.chmouel.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.chmouel.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.chmouel.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.chmouel.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Avoiding race conditions between containers with docker and fig"><meta property="og:description" content="I have been playing with docker quite a lot lately. The advantage for me is to be able to run functional tests easily and be able to document how deployment should be done of my software as a developer for my endusers (i.e: operators/admins).
The advantage of this method is probably an article of its own which I won&rsquo;t dig into today but just to give a tip for the existing users of fig/docker"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.chmouel.com/2014/11/04/avoiding-race-conditions-between-containers-with-docker-and-fig/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2014-11-04T20:18:01+00:00"><meta property="article:modified_time" content="2014-11-04T20:18:01+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Avoiding race conditions between containers with docker and fig"><meta name=twitter:description content="I have been playing with docker quite a lot lately. The advantage for me is to be able to run functional tests easily and be able to document how deployment should be done of my software as a developer for my endusers (i.e: operators/admins).
The advantage of this method is probably an article of its own which I won&rsquo;t dig into today but just to give a tip for the existing users of fig/docker"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.chmouel.com/posts/"},{"@type":"ListItem","position":2,"name":"Avoiding race conditions between containers with docker and fig","item":"https://blog.chmouel.com/2014/11/04/avoiding-race-conditions-between-containers-with-docker-and-fig/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Avoiding race conditions between containers with docker and fig","name":"Avoiding race conditions between containers with docker and fig","description":"I have been playing with docker quite a lot lately. The advantage for me is to be able to run functional tests easily and be able to document how deployment should be done of my software as a developer for my endusers (i.e: operators/admins).\nThe advantage of this method is probably an article of its own which I won\u0026rsquo;t dig into today but just to give a tip for the existing users of fig/docker","keywords":["Docker"],"articleBody":"\nI have been playing with docker quite a lot lately. The advantage for me is to be able to run functional tests easily and be able to document how deployment should be done of my software as a developer for my endusers (i.e: operators/admins).\nThe advantage of this method is probably an article of its own which I won’t dig into today but just to give a tip for the existing users of fig/docker\nIt’s easy to get race conditions with fig and docker. Take for example, if you have a common pattern when you have a web and a DB, the DB will start before the Web server as orchestrated by fig and link to each others; but since the DB server didn’t have time to configure itself and web has already started it would just fail connecting for it.\nIn an ideal world the app should wait for DB to be up and setup before starting to connect to it but that’s not something easy all the time.\nPeople of docker and fig have noticed that and there is some proposal for that from a fig dev :\nhttps://github.com/docker/docker/issues/7445The idea there is to have docker waiting that the exposed port is open and listening to be able to set that said container as started. This is not something easy to do since docker would have an hard time to figure out if (and how) that port is open.\nUntil there is a resolution that comes up you can always resort to the shell script to get it done. There is multiple tool that can check if a port is open\nfrom ping to netcat or curl etc. It really depend of what you are allowing to have into your base container.\nSince most of my devs involved Python, I do always have them in my containers so\nI came up with some built-in python solution, that looks like this :\nand in my start.sh of my app server I use it like this before starting my app server:\ncheck_up \"DB Server\" ${DB_PORT_3306_TCP_ADDR} 3306  the advantage of this method is that it’s pretty fast to just look over the\nopening the socket until it’s getting open and fail fast.\nHope this helps.\n","wordCount":"373","inLanguage":"en","datePublished":"2014-11-04T20:18:01Z","dateModified":"2014-11-04T20:18:01Z","author":{"@type":"Person","name":"chmouel"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.chmouel.com/2014/11/04/avoiding-race-conditions-between-containers-with-docker-and-fig/"},"publisher":{"@type":"Organization","name":"Chmouel's blog","logo":{"@type":"ImageObject","url":"https://blog.chmouel.com/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://blog.chmouel.com/ accesskey=h title="Chmouel's blog (Alt + H)">Chmouel's blog</a>
<span class=logo-switches></span></div><ul id=menu><li><a href=https://github.com/chmouel/ title=Github><span>Github</span></a></li><li><a href=https://photos.chmouel.com title=Photos><span>Photos</span></a></li><li><a href=https://app.strava.com/athletes/126695 title=Strava><span>Strava</span></a></li><li><a href=https://twitter.com/chmouel title=Twitter><span>Twitter</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Avoiding race conditions between containers with docker and fig</h1><div class=post-meta><span title="2014-11-04 20:18:01 +0000 UTC">November 4, 2014</span></div></header><div class=post-content><p><a href=/wp-content/uploads/2014/11/figs.jpg></a></p><p>I have been playing with docker quite a lot lately. The advantage for me is to be able to run functional tests easily and be able to document how deployment should be done of my software as a developer for my endusers (i.e: operators/admins).</p><p>The advantage of this method is probably an article of its own which I won&rsquo;t dig into today but just to give a tip for the existing users of fig/docker</p><p>It&rsquo;s easy to get race conditions with fig and docker. Take for example, if you have a common pattern when you have a web and a DB, the DB will start before the Web server as orchestrated by fig and link to each others; but since the DB server didn&rsquo;t have time to configure itself and web has already started it would just fail connecting for it.</p><p>In an ideal world the app should wait for DB to be up and setup before starting to connect to it but that&rsquo;s not something easy all the time.</p><p>People of docker and fig have noticed that and there is some proposal for that from a fig dev :</p><p><a href=https://github.com/docker/docker/issues/7445>https://github.com/docker/docker/issues/7445</a></p><p>The idea there is to have docker waiting that the exposed port is open and listening to be able to set that said container as started. This is not something easy to do since docker would have an hard time to figure out if (and how) that port is open.</p><p>Until there is a resolution that comes up you can always resort to the shell script to get it done. There is multiple tool that can check if a port is open<br>from ping to netcat or curl etc. It really depend of what you are allowing to have into your base container.</p><p>Since most of my devs involved Python, I do always have them in my containers so<br>I came up with some built-in python solution, that looks like this :</p><p>and in my start.sh of my app server I use it like this before starting my app server:</p><pre><code>check_up &quot;DB Server&quot; ${DB_PORT_3306_TCP_ADDR} 3306
</code></pre><p>the advantage of this method is that it&rsquo;s pretty fast to just look over the<br>opening the socket until it&rsquo;s getting open and fail fast.</p><p>Hope this helps.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.chmouel.com/tags/docker/>Docker</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://blog.chmouel.com/>Chmouel's blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>