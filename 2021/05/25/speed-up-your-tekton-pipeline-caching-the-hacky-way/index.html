<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Speed up your tekton pipeline caching the hacky way | Chmouel's blog</title>
<meta name=keywords content><meta name=description content="There is one thing that can get your wind up when you try to iterate quickly in a PR is to have a slow CI.
While working on a go project with a comprehensive test suite it was usually taking over 20 to 30 minutes to run and being as patient as a kid waiting for her candy floss to be ready I am eagerly waiting that my pipeline is Green or not."><meta name=author content><link rel=canonical href=https://blog.chmouel.com/2021/05/25/speed-up-your-tekton-pipeline-caching-the-hacky-way/><link crossorigin=anonymous href=/assets/css/stylesheet.64c0facf6d5e1ef4ef755a65dddfd0ca77a821e28a77091dc4792f2618c595b3.css integrity="sha256-ZMD6z21eHvTvdVpl3d/QyneoIeKKdwkdxHkvJhjFlbM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://blog.chmouel.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.chmouel.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.chmouel.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.chmouel.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.chmouel.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Speed up your tekton pipeline caching the hacky way"><meta property="og:description" content="There is one thing that can get your wind up when you try to iterate quickly in a PR is to have a slow CI.
While working on a go project with a comprehensive test suite it was usually taking over 20 to 30 minutes to run and being as patient as a kid waiting for her candy floss to be ready I am eagerly waiting that my pipeline is Green or not."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.chmouel.com/2021/05/25/speed-up-your-tekton-pipeline-caching-the-hacky-way/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-25T08:51:33+00:00"><meta property="article:modified_time" content="2021-05-25T08:51:33+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Speed up your tekton pipeline caching the hacky way"><meta name=twitter:description content="There is one thing that can get your wind up when you try to iterate quickly in a PR is to have a slow CI.
While working on a go project with a comprehensive test suite it was usually taking over 20 to 30 minutes to run and being as patient as a kid waiting for her candy floss to be ready I am eagerly waiting that my pipeline is Green or not."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.chmouel.com/posts/"},{"@type":"ListItem","position":2,"name":"Speed up your tekton pipeline caching the hacky way","item":"https://blog.chmouel.com/2021/05/25/speed-up-your-tekton-pipeline-caching-the-hacky-way/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Speed up your tekton pipeline caching the hacky way","name":"Speed up your tekton pipeline caching the hacky way","description":"There is one thing that can get your wind up when you try to iterate quickly in a PR is to have a slow CI.\nWhile working on a go project with a comprehensive test suite it was usually taking over 20 to 30 minutes to run and being as patient as a kid waiting for her candy floss to be ready I am eagerly waiting that my pipeline is Green or not.","keywords":[],"articleBody":"There is one thing that can get your wind up when you try to iterate quickly in a PR is to have a slow CI.\nWhile working on a go project with a comprehensive test suite it was usually taking over 20 to 30 minutes to run and being as patient as a kid waiting for her candy floss to be ready I am eagerly waiting that my pipeline is Green or not.\nMy pipeline wasn’t that complicated, it’s a typical go project one, it has only a few steps which can be described like this :\nCheckout the git repo in a Tekton workspace (PVC) to the commit SHA we want to be tested. Run my functional/unit tests (I don’t have e2e tests yet :) but that should be step three when it’s done) Run some linting on my code with golangci-lint Run some other linters like yamllint. As a good cloud native citizen Tekton spins up a new pod and attaches our pvc/workspace to it, and in each pods where a step is using go, the go compiler recompiles my dependencies I have vendored in my vendor directory.\nI am vendoring inside my repository so at least I don’t have `go mod` downloading again and again, but the go compilation can get very slow.\nAt first, I made a large container with a large image that had all the tools (which is Tekton upstream test-runner image) to speeds by a good time albeit it was still relatively slow compared to running it on my laptop to run the testsuite.\nI decided to go the “hacky way”, I would save the cache as often as possible to help the go compiler as much as possible.\nThis would use a toy project of mine called go-simple-uploader which is a simple go http server to upload and serve files to “cache my cache”.\nAt first I deployed the go-simple-uploader binary inside a kubernetes Deployment in front of a “Service”. The service will be accessible to every pod inside that same namespace, to its service name “http://uploader:8080”.\nI modified my pipeline so at first step I would check if there is a cache file and uncompress it :\n- image: mirror.gcr.io/library/golang:latest name: get-cache workingDir: $(workspaces.source.path) script: | #!/usr/bin/env bash set -ex mkdir -p go-build-cache;cd go-build-cache curl -fsI http://uploader:8080/golang-cache.tar || { echo \"no cache found\" exit 0 } echo \"Getting cache\" curl http://uploader:8080/golang-cache.tar|tar -x -f- This step does a few things :\nIt uses the golang official image because I know it will be used later on in my pipeline so I don’t care as much to have a small image and I can use a bash/curl in there. It uses the source workspaces where I have my code checked out in from the git-clone task and create the go-build-cache directory If it finds the file called golang-cache.tar It uncompressed it as quickly as possible. Later on in my pipeline, I have another task with multiple steps. I have moved away from using multiple tasks because PVC attachment can get quite slow. While a tekton task is a single pod where each steps are a container the steps looks like this :\n- name: unitlint runAfter: - get-cache taskSpec: steps: - name: unittest image: mirror.gcr.io/library/golang:latest workingDir: $(workspaces.source.path) script: | mkdir -p $HOME/.cache/ \u0026\u0026 ln -vs $(workspaces.source.path)/go-build-cache $HOME/.cache/go-build make test - name: lint image: quay.io/app-sre/golangci-lint workingDir: $(workspaces.source.path) script: | mkdir -p $HOME/.cache/ \u0026\u0026 ln -vfs $(workspaces.source.path)/go-build-cache $HOME/.cache/go-build mkdir -p $HOME/.cache/ \u0026\u0026 ln -vfs $(workspaces.source.path)/go-build-cache $HOME/.cache/golangci-lint make lint-go This task run after `get-cache` the key part is where I symlink the go-build-cache directory to $HOME/.cache/go-build directory\nSames goes for golangci-lint I symlink its cache directory to $HOME/cache/golangci-lint\nLater on I have another task that save this cache :\n- name: save-cache workingDir: $(workspaces.source.path) script: | #!/usr/bin/env bash curl -o/dev/null -s -f -X POST -F path=test -F file=@/etc/motd http://uploader:8080/upload || { echo \"No cache server found\" exit 0 } lm=\"$(curl -fsI http://uploader:8080/golang-cache.tar|sed -n '/Last-Modified/ { s/Last-Modified: //;s/\\r//; p}')\" if [[ -n ${lm} ]];then expired=$(python -c \"import datetime, sys;print(datetime.datetime.now() \u003e datetime.datetime.strptime(sys.argv[1], '%a, %d %b %Y %X %Z') + datetime.timedelta(days=1))\" \"${lm}\") [[ ${expired} == \"False\" ]] \u0026\u0026 { echo \"Cache is younger than a day\" exit } fi cd $(workspaces.source.path)/go-build-cache tar cf - . |curl -# -L -f -F path=golang-cache.tar -X POST -F \"file=@-\" http://uploader:8080/upload The task starts by checking if you have a cache server and then with the help of some shell and python magic checking with the “Last-Modified” http header if you have a cache file that has already been generated since over a day.\nI am doing this because at first I was using a uploading server in another environment which could get quite slow to upload on every run, since we run in the same namespace the upload is very fast so this is probably not needed, but keeping it here if someone else needs it.\nIt then uploads the cache file where it would be available for the subsequent runs using the first get-cache task.\nThings got much faster, starting with my pipeline going over 10/12 minute at first run, it will get down to 2mn on the next runs. It gets as slow as your infra, the time for kubernetes to spin up the pods really, it could get under 1mn if I am running my pipeline under Kind.\nThis is pretty KISS and may actually work on any pipelines that needs caching (I am looking at you java maven and nodejs npm).\nNow the best way probably to address this in a generic way is to have a task in the tektoncd/catalog that behaves like the Github Action cache where the user can specify a parameter for the cache key, a TTL and a directory and maybe the storage type (ie: like an object storage or a simple http uploader or even another PVC) and the task automatically do everything at the start of your pipeline and by the end with in a finally task.\nHopefully we can get this done in the near future.\n","wordCount":"1005","inLanguage":"en","datePublished":"2021-05-25T08:51:33Z","dateModified":"2021-05-25T08:51:33Z","author":{"@type":"Person","name":"chmouel"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.chmouel.com/2021/05/25/speed-up-your-tekton-pipeline-caching-the-hacky-way/"},"publisher":{"@type":"Organization","name":"Chmouel's blog","logo":{"@type":"ImageObject","url":"https://blog.chmouel.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.chmouel.com/ accesskey=h title="Chmouel's blog (Alt + H)">Chmouel's blog</a>
<span class=logo-switches></span></div><ul id=menu><li><a href=https://photos.chmouel.com title=camera><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><title>Photo Website</title><path d="M149.1 64.8 138.7 96H64C28.7 96 0 124.7.0 160V416c0 35.3 28.7 64 64 64H448c35.3.0 64-28.7 64-64V160c0-35.3-28.7-64-64-64H373.3L362.9 64.8C356.4 45.2 338.1 32 317.4 32H194.6c-20.7.0-39 13.2-45.5 32.8zM256 192a96 96 0 110 192 96 96 0 110-192z"/></svg><span></span></a></li><li><a href=https://github.com/chmouel/ title=GitHub><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg><span></span></a></li><li><a href=https://fosstodon.org/@chmouel title=Mastodon><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg><span></span></a></li><li><a href=https://redhat.com title=redhat><svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" id="b6bdd2b4-52ab-488a-9a30-1e6d1d7dd2d4" data-name="Layer 1" viewBox="0 0 192.30001 146" sodipodi:docname="logo.svg" width="192.3" height="146" inkscape:version="0.92.5 (2060ec1f9f, 2020-04-08)"><sodipodi:namedview bordercolor="#666666" borderopacity="1" objecttolerance="10" gridtolerance="10" guidetolerance="10" inkscape:pageopacity="0" inkscape:pageshadow="2" inkscape:window-width="1920" inkscape:window-height="1007" id="namedview13" showgrid="false" fit-margin-top="1" fit-margin-right="1" fit-margin-bottom="1" fit-margin-left="1" inkscape:zoom=".45930043" inkscape:cx="306.89999" inkscape:cy="73" inkscape:window-x="0" inkscape:window-y="0" inkscape:window-maximized="1" inkscape:current-layer="b6bdd2b4-52ab-488a-9a30-1e6d1d7dd2d4"/><title>Red Hat</title><path class="a737459c-e8c7-4afa-8008-f6cfd15ccda2" d="m128 84c12.5.0 30.6-2.6 30.6-17.5a19.53 19.53.0 00-.3-3.4L150.9 30.7C149.2 23.6 147.7 20.3 135.2 14.1 125.5 9.1 104.4 1 98.1 1 92.2 1 90.5 8.5 83.6 8.5 76.9 8.5 72 2.9 65.7 2.9c-6 0-9.9 4.1-12.9 12.5.0.0-8.4 23.7-9.5 27.2a6.15 6.15.0 00-.2 1.9C43 53.7 79.3 83.9 128 84m32.5-11.4c1.7 8.2 1.7 9.1 1.7 10.1.0 14-15.7 21.8-36.4 21.8C79 104.5 38.1 77.1 38.1 59a18.35 18.35.0 011.5-7.3C22.8 52.5 1 55.5 1 74.7 1 106.2 75.6 145 134.6 145c45.3.0 56.7-20.5 56.7-36.7.0-12.7-11-27.1-30.8-35.7" id="path8" inkscape:connector-curvature="0"/><path d="m160.5 72.6c1.7 8.2 1.7 9.1 1.7 10.1.0 14-15.7 21.8-36.4 21.8C79 104.5 38.1 77.1 38.1 59a18.35 18.35.0 011.5-7.3l3.7-9.1a6.15 6.15.0 00-.2 1.9c0 9.2 36.3 39.4 84.9 39.4 12.5.0 30.6-2.6 30.6-17.5A19.53 19.53.0 00158.3 63z" id="path10" inkscape:connector-curvature="0"/></svg><span></span></a></li><li><a href=https://app.strava.com/athletes/126695 title=Strava><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M158.4.0 7 292h89.2l62.2-116.1L220.1 292h88.5zm150.2 292-43.9 88.2-44.6-88.2h-67.6l112.2 220 111.5-220z"/></svg><span></span></a></li><li><a href=https://twitter.com/chmouel title=Twitter><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg><span></span></a></li><li><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Speed up your tekton pipeline caching the hacky way</h1><div class=post-meta><span title='2021-05-25 08:51:33 +0000 UTC'>May 25, 2021</span>&nbsp;|&nbsp;<a href=https://github.com/chmouel/blog/tree/main/content/posts/2021-05-25-speed-up-your-tekton-pipeline-caching-the-hacky-way.md rel="noopener noreferrer" target=_blank>Edit</a></div></header><div class=post-content><p>There is one thing that can get your wind up when you try to iterate quickly in a PR is to have a slow CI.</p><p>While working on a go project with a comprehensive test suite it was usually taking over 20 to 30 minutes to run and being as patient as a kid waiting for her candy floss to be ready I am eagerly waiting that my pipeline is Green or not.</p><p>My pipeline wasn&rsquo;t that complicated, it&rsquo;s a typical go project one, it has only a few steps which can be described like this :</p><ol><li>Checkout the git repo in a <a href=https://github.com/tektoncd/pipeline/blob/main/docs/workspaces.md>Tekton workspace</a> (PVC) to the commit SHA we want to be tested.</li><li>Run my functional/unit tests</li><li>(I don&rsquo;t have e2e tests yet :) but that should be step three when it&rsquo;s done)</li><li>Run some linting on my code with <a href=https://golangci-lint.run/>golangci-lint</a></li><li>Run some other linters like yamllint.</li></ol><p>As a good cloud native citizen <a href=http://github.com/tektoncd/pipeline>Tekton</a> spins up a new pod and attaches our pvc/workspace to it, and in each pods where a step is using go, the go compiler recompiles my dependencies I have vendored in my vendor directory.</p><p>I am vendoring inside my repository so at least I don&rsquo;t have `go mod` downloading again and again, but the go compilation can get very slow.</p><p>At first, I made a large container with a large image that had all the tools (which is Tekton upstream <a href=https://github.com/tektoncd/plumbing/blob/main/tekton/images/test-runner/>test-runner image</a>) to speeds by a good time albeit it was still relatively slow compared to running it on my laptop to run the testsuite.</p><p>I decided to go the &ldquo;hacky way&rdquo;, I would save the cache as often as possible to help the go compiler as much as possible.</p><p>This would use a toy project of mine called <a href=https://github.com/chmouel/go-simple-uploader>go-simple-uploader</a> which is a simple go http server to upload and serve files to &ldquo;cache my cache&rdquo;.</p><p>At first I <a href=https://github.com/chmouel/go-simple-uploader/blob/master/kubernetes/deployment.yaml>deployed</a> the go-simple-uploader binary inside a kubernetes Deployment in front of a &ldquo;Service&rdquo;. The service will be accessible to every pod inside that same namespace, to its service name &ldquo;http://uploader:8080&rdquo;.</p><p>I modified my pipeline so at first step I would check if there is a cache file and uncompress it :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span>    - <span style=color:#ff79c6>image</span>: mirror.gcr.io/library/golang:latest
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: get-cache
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>workingDir</span>: $(workspaces.source.path)
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>script</span>: |<span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>         #!/usr/bin/env bash
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>         set -ex
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>         mkdir -p go-build-cache;cd go-build-cache
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>         curl -fsI http://uploader:8080/golang-cache.tar || {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>              echo &#34;no cache found&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>              exit 0
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>         }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>         echo &#34;Getting cache&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>         curl http://uploader:8080/golang-cache.tar|tar -x -f-</span>         
</span></span></code></pre></div><p>This step does a few things :</p><ul><li>It uses the golang official image because I know it will be used later on in my pipeline so I don&rsquo;t care as much to have a small image and I can use a bash/curl in there.</li><li>It uses the source workspaces where I have my code checked out in from the <a href=https://github.com/tektoncd/catalog/blob/main/task/git-clone/0.3/git-clone.yaml>git-clone task</a> and create the <em>go-build-cache</em> directory</li><li>If it finds the file called golang-cache.tar It uncompressed it as quickly as possible.</li></ul><p>Later on in my pipeline, I have another task with multiple steps. I have moved away from using multiple tasks because PVC attachment can get quite slow. While a <a href=https://github.com/tektoncd/pipeline/blob/main/docs/tasks.md#overview>tekton task</a> is a single pod where each steps are a container the steps looks like this :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span>    - <span style=color:#ff79c6>name</span>: unitlint
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>runAfter</span>:
</span></span><span style=display:flex><span>        - get-cache
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>taskSpec</span>:
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>steps</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ff79c6>name</span>: unittest
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>image</span>: mirror.gcr.io/library/golang:latest
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>workingDir</span>: $(workspaces.source.path)
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>script</span>: |<span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                mkdir -p $HOME/.cache/ &amp;&amp; ln -vs $(workspaces.source.path)/go-build-cache $HOME/.cache/go-build
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                make test</span>                
</span></span><span style=display:flex><span>          - <span style=color:#ff79c6>name</span>: lint
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>image</span>: quay.io/app-sre/golangci-lint
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>workingDir</span>: $(workspaces.source.path)
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>script</span>: |<span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                mkdir -p $HOME/.cache/ &amp;&amp; ln -vfs $(workspaces.source.path)/go-build-cache $HOME/.cache/go-build
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                mkdir -p $HOME/.cache/ &amp;&amp; ln -vfs $(workspaces.source.path)/go-build-cache $HOME/.cache/golangci-lint</span>                
</span></span><span style=display:flex><span>            make lint-go
</span></span></code></pre></div><p>This task run after `get-cache` the key part is where I symlink the go-build-cache directory to <em>$HOME/.cache/go-build</em> directory</p><p>Sames goes for golangci-lint I symlink its cache directory to <em>$HOME/cache/golangci-lint</em></p><p>Later on I have another task that save this cache :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span>    - <span style=color:#ff79c6>name</span>: save-cache
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>workingDir</span>: $(workspaces.source.path)
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>script</span>: |<span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        #!/usr/bin/env bash
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        curl -o/dev/null -s -f -X POST -F path=test -F file=@/etc/motd  http://uploader:8080/upload || {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            echo &#34;No cache server found&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            exit 0
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>         }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        lm=&#34;$(curl -fsI http://uploader:8080/golang-cache.tar|sed -n &#39;/Last-Modified/ { s/Last-Modified: //;s/\r//; p}&#39;)&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>         if [[ -n ${lm} ]];then
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>              expired=$(python -c &#34;import datetime, sys;print(datetime.datetime.now() &gt; datetime.datetime.strptime(sys.argv[1], &#39;%a, %d %b %Y %X %Z&#39;) + datetime.timedelta(days=1))&#34; &#34;${lm}&#34;)
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>               [[ ${expired} == &#34;False&#34; ]] &amp;&amp; {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                 echo &#34;Cache is younger than a day&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                 exit
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          fi
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          cd $(workspaces.source.path)/go-build-cache
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          tar cf - . |curl -# -L -f -F path=golang-cache.tar -X POST -F &#34;file=@-&#34; http://uploader:8080/upload</span>        
</span></span></code></pre></div><p>The task starts by checking if you have a cache server and then with the help of some shell and python magic checking with the &ldquo;Last-Modified&rdquo; http header if you have a cache file that has already been generated since over a day.</p><p>I am doing this because at first I was using a uploading server in another environment which could get quite slow to upload on every run, since we run in the same namespace the upload is very fast so this is probably not needed, but keeping it here if someone else needs it.</p><p>It then uploads the cache file where it would be available for the subsequent runs using the first <code>get-cache</code> task.</p><p>Things got much faster, starting with my pipeline going over 10/12 minute at first run, it will get down to 2mn on the next runs. It gets as slow as your infra, the time for kubernetes to spin up the pods really, it could get under 1mn if I am running my pipeline under <a href=https://kind.sigs.k8s.io/docs/user/quick-start/>Kind.</a></p><p><img loading=lazy src=/wp-content/uploads/2021/05/image-1024x764.png alt></p><p>This is pretty KISS and may actually work on any pipelines that needs caching (I am looking at you java maven and nodejs npm).</p><p>Now the best way probably to address this in a generic way is to have a task in the <a href=http://github.com/tektoncd/catalog>tektoncd/catalog</a> that behaves like the Github Action <a href=https://github.com/marketplace/actions/cache>cache</a> where the user can specify a parameter for the cache key, a TTL and a directory and maybe the storage type (ie: like an object storage or a simple http uploader or even another PVC) and the task automatically do everything at the start of your pipeline and by the end with in a <a href=https://github.com/jerop/pipeline/blob/weinft/docs/pipelines.md#guard-finally-task-execution-using-whenexpressions>finally task</a>.</p><p>Hopefully we can get this done in the near future.</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://blog.chmouel.com/>Chmouel's blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>