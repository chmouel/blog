<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How to make a release pipeline with Pipelines as Code | Chmouel's blog</title><meta name=keywords content><meta name=description content="One of the early goal of Pipelines as Codeon Tekton is to make sure we were able to have the project CI running with itself.
The common user case of validating pull request was quickly implemented and you can find more information about it in this walkthough video :
  For slightly more advanced use case here is how we made a release pipeline for the project.
The goal is when we tag a release and push the tags to the GitHUB repo it will"><meta name=author content><link rel=canonical href=https://blog.chmouel.com/2021/07/01/how-to-make-a-release-pipeline-with-pipelines-as-code/><link crossorigin=anonymous href=/assets/css/stylesheet.min.728ea2f434b33fa1b064a11c2ed6c7a0ce2b565a62f7e5d41efdd439ef56b3f1.css integrity="sha256-co6i9DSzP6GwZKEcLtbHoM4rVlpi9+XUHv3UOe9Ws/E=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.chmouel.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.chmouel.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.chmouel.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.chmouel.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.chmouel.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="How to make a release pipeline with Pipelines as Code"><meta property="og:description" content="One of the early goal of Pipelines as Codeon Tekton is to make sure we were able to have the project CI running with itself.
The common user case of validating pull request was quickly implemented and you can find more information about it in this walkthough video :
  For slightly more advanced use case here is how we made a release pipeline for the project.
The goal is when we tag a release and push the tags to the GitHUB repo it will"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.chmouel.com/2021/07/01/how-to-make-a-release-pipeline-with-pipelines-as-code/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-07-01T12:44:25+00:00"><meta property="article:modified_time" content="2021-07-01T12:44:25+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="How to make a release pipeline with Pipelines as Code"><meta name=twitter:description content="One of the early goal of Pipelines as Codeon Tekton is to make sure we were able to have the project CI running with itself.
The common user case of validating pull request was quickly implemented and you can find more information about it in this walkthough video :
  For slightly more advanced use case here is how we made a release pipeline for the project.
The goal is when we tag a release and push the tags to the GitHUB repo it will"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.chmouel.com/posts/"},{"@type":"ListItem","position":2,"name":"How to make a release pipeline with Pipelines as Code","item":"https://blog.chmouel.com/2021/07/01/how-to-make-a-release-pipeline-with-pipelines-as-code/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How to make a release pipeline with Pipelines as Code","name":"How to make a release pipeline with Pipelines as Code","description":"One of the early goal of Pipelines as Codeon Tekton is to make sure we were able to have the project CI running with itself.\nThe common user case of validating pull request was quickly implemented and you can find more information about it in this walkthough video :\n  For slightly more advanced use case here is how we made a release pipeline for the project.\nThe goal is when we tag a release and push the tags to the GitHUB repo it will","keywords":[],"articleBody":"One of the early goal of Pipelines as Codeon Tekton is to make sure we were able to have the project CI running with itself.\nThe common user case of validating pull request was quickly implemented and you can find more information about it in this walkthough video :\n  For slightly more advanced use case here is how we made a release pipeline for the project.\nThe goal is when we tag a release and push the tags to the GitHUB repo it will\n Generate the release.yaml file for that version for user to automatically kubectl apply -f- it. Upload that release.yaml to a release-${version} branch Generate the tkn-pac binaries for the different Operating Systems Generate the GitHUB release.  To be able to do so, I created a Repository CR in the pipelines-as-code-ci namespace:\napiVersion: pipelinesascode.tekton.dev/v1alpha1 kind: Repository metadata:  name: pipelines-as-code-ci-make-release  namespace: pipelines-as-code-ci spec:  branch: refs/tags/*  event_type: push  namespace: pipelines-as-code-ci  url: https://github.com/openshift-pipelines/pipelines-as-code The key part is the branch and event_type spec fields, where in plain english means I want to have all the tags push handled and run in the namespace pipelines-as-code-ci\nI then created a [release-pipeline.yaml][3] PipelineRun in my .tekton directory with the annotations needed:\npipelinesascode.tekton.dev/on-event: \"[push]\" pipelinesascode.tekton.dev/on-target-branch: \"[refs/tags/*]\" Which mean in pain english that this pipelinerun will handle all on push tags events.\nIn my tasks I need the git-clone tasks and a custom version of the goreleaser task located inside my repository in [.tekton/task/goreleaser.yaml][4].\nThe annotation for this looks like this :\npipelinesascode.tekton.dev/task: \"[git-clone, .tekton/tasks/goreleaser.yaml]\" Goreleaser takes care of a lot of things for us, it compiles all binary and make a release in GitHub, it as well has the ability to generate a homebrew release in openshift-pipelines/homebrew-pipelines-as-code/ so user on OSX or LinuxBrew can easily just do :\nbrew install openshift-pipelines/pipelines-as-code/tektoncd-pac Uploading the release.yaml si done with a Python script I wrote for it :\nhttps://github.com/openshift-pipelines/pipelines-as-code/blob/main/hack/upload-file-to-github.py\nIt will fetch the tag SHA and create a branch release-${tagversion} and push the file into it. This gives a stable branch with all the artifacts specifique to that version.\nAfter all of that, I just need to edit the release and change a few fields to make it a bit nicer and set it as release (by default goreleaser do a prerelease)\nHere is the link to all the files :\n .gorelease.yaml the configuration file for goreleaser upload-file-to-github.py - The python script to upload a file to GitHub directly .tekton/release-pipeline.yaml - The tekton release pipeline  ","wordCount":"406","inLanguage":"en","datePublished":"2021-07-01T12:44:25Z","dateModified":"2021-07-01T12:44:25Z","author":{"@type":"Person","name":"chmouel"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.chmouel.com/2021/07/01/how-to-make-a-release-pipeline-with-pipelines-as-code/"},"publisher":{"@type":"Organization","name":"Chmouel's blog","logo":{"@type":"ImageObject","url":"https://blog.chmouel.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.chmouel.com/ accesskey=h title="Chmouel's blog (Alt + H)">Chmouel's blog</a>
<span class=logo-switches></span></div><ul id=menu><li><a href=https://github.com/chmouel/ title=Github><span>Github</span></a></li><li><a href=https://photos.chmouel.com title=Photos><span>Photos</span></a></li><li><a href=https://app.strava.com/athletes/126695 title=Strava><span>Strava</span></a></li><li><a href=https://twitter.com/chmouel title=Twitter><span>Twitter</span></a></li><li><a href=https://redhat.com title=Work><span>Work</span></a></li><li><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>How to make a release pipeline with Pipelines as Code</h1><div class=post-meta><span title="2021-07-01 12:44:25 +0000 UTC">July 1, 2021</span>&nbsp;|&nbsp;<a href=https://github.com/chmouel/blog/tree/main/content/posts/2021-07-01-how-to-make-a-release-pipeline-with-pipelines-as-code.md rel="noopener noreferrer" target=_blank>Edit</a></div></header><div class=post-content><p>One of the early goal of Pipelines as Code on Tekton is to make sure we were able to have the project CI running with itself.</p><p>The common user case of validating pull request was quickly implemented and you can find more information about it in this walkthough video :</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube-nocookie.com/embed/Uh1YhOGPOes style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div><p>For slightly more advanced use case here is how we made a release pipeline for the project.</p><p>The goal is when we tag a release and push the tags to the GitHUB repo it will</p><ul><li>Generate the release.yaml file for that version for user to automatically <em><code>kubectl apply -f-</code></em> it.</li><li>Upload that release.yaml to a <code>release-${version} branch</code></li><li>Generate the <code>tkn-pac</code> binaries for the different Operating Systems</li><li>Generate the GitHUB release.</li></ul><p>To be able to do so, I created a Repository CR in the <code>pipelines-as-code-ci</code> namespace:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: pipelinesascode.tekton.dev/v1alpha1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: Repository
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: pipelines-as-code-ci-make-release
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>namespace</span>: pipelines-as-code-ci
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>branch</span>: refs/tags/*
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>event_type</span>: push
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>namespace</span>: pipelines-as-code-ci
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>url</span>: https://github.com/openshift-pipelines/pipelines-as-code
</span></span></code></pre></div><p>The key part is the <code>branch</code> and <code>event_type</code> spec fields, where in plain
english means I want to have all the tags push handled and run in the namespace
<code>pipelines-as-code-ci</code></p><p>I then created a [release-pipeline.yaml][3] PipelineRun in my <code>.tekton</code>
directory with the annotations needed:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>pipelinesascode.tekton.dev/on-event</span>: <span style=color:#f1fa8c>&#34;[push]&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>pipelinesascode.tekton.dev/on-target-branch</span>: <span style=color:#f1fa8c>&#34;[refs/tags/*]&#34;</span>&lt;/pre&gt;
</span></span></code></pre></div><p>Which mean in pain english that this pipelinerun will handle all on push tags events.</p><p>In my tasks I need the git-clone tasks and a custom version of the goreleaser
task located inside my repository in [.tekton/task/goreleaser.yaml][4].</p><p>The annotation for this looks like this :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>pipelinesascode.tekton.dev/task</span>: <span style=color:#f1fa8c>&#34;[git-clone, .tekton/tasks/goreleaser.yaml]&#34;</span>
</span></span></code></pre></div><p><a href=https://goreleaser.com/>Goreleaser</a> takes care of a lot of things for us, it compiles all binary and make a release in GitHub, it as well has the ability to generate a <a href=https://brew.sh>homebrew</a> release in <a href=https://github.com/openshift-pipelines/homebrew-pipelines-as-code/>openshift-pipelines/homebrew-pipelines-as-code/</a> so user on OSX or LinuxBrew can easily just do :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>brew install openshift-pipelines/pipelines-as-code/tektoncd-pac
</span></span></code></pre></div><p>Uploading the release.yaml si done with a Python script I wrote for it :</p><p><a href=https://github.com/openshift-pipelines/pipelines-as-code/blob/main/hack/upload-file-to-github.py>https://github.com/openshift-pipelines/pipelines-as-code/blob/main/hack/upload-file-to-github.py</a></p><p>It will fetch the tag SHA and create a branch release-${tagversion} and push the file into it. This gives a stable branch with all the artifacts specifique to that version.</p><p>After all of that, I just need to edit the release and change a few fields to make it a bit nicer and set it as release (by default goreleaser do a prerelease)</p><p><img loading=lazy src=/wp-content/uploads/2021/07/image-1024x354.png alt></p><p>Here is the link to all the files :</p><ul><li><a href=https://github.com/openshift-pipelines/pipelines-as-code/blob/main/.goreleaser.yml>.gorelease.yaml</a> the configuration file for goreleaser</li><li><a href=https://github.com/openshift-pipelines/pipelines-as-code/blob/main/hack/upload-file-to-github.py>upload-file-to-github.py</a> - The python script to upload a file to GitHub directly</li><li><a href=https://github.com/openshift-pipelines/pipelines-as-code/blob/main/.tekton/release-pipeline.yaml>.tekton/release-pipeline.yaml</a> - The tekton release pipeline</li></ul></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://blog.chmouel.com/>Chmouel's blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>