<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>The trick to get your wordpress behind a reverse proxy | Chmouel's blog</title><meta name=keywords content="Misc,Programming,Scripts"><meta name=description content="I have been meaning to get this blog SSL protected for a while and since solution like letsencrypt makes it easy I have generated some SSL keys for my domain and configured it in apache.
So far so good, but the thing is my VM at my hosting provider is pretty small and I have been using varnish for quite some time or I would get out of memory quickly some the kernel OOM killer kicking1 it."><meta name=author content><link rel=canonical href=https://blog.chmouel.com/2016/09/22/the-trick-to-get-your-wordpress-behind-a-reverse-proxy/><link crossorigin=anonymous href=/assets/css/stylesheet.min.286ffbab1cfdcf5c35ec0edbfc67759192b408de6939c558bbd4a964ca89f552.css integrity="sha256-KG/7qxz9z1w17A7b/Gd1kZK0CN5pOcVYu9SpZMqJ9VI=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.chmouel.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.chmouel.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.chmouel.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.chmouel.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.chmouel.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="The trick to get your wordpress behind a reverse proxy"><meta property="og:description" content="I have been meaning to get this blog SSL protected for a while and since solution like letsencrypt makes it easy I have generated some SSL keys for my domain and configured it in apache.
So far so good, but the thing is my VM at my hosting provider is pretty small and I have been using varnish for quite some time or I would get out of memory quickly some the kernel OOM killer kicking1 it."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.chmouel.com/2016/09/22/the-trick-to-get-your-wordpress-behind-a-reverse-proxy/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-09-22T10:27:27+00:00"><meta property="article:modified_time" content="2016-09-22T10:27:27+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="The trick to get your wordpress behind a reverse proxy"><meta name=twitter:description content="I have been meaning to get this blog SSL protected for a while and since solution like letsencrypt makes it easy I have generated some SSL keys for my domain and configured it in apache.
So far so good, but the thing is my VM at my hosting provider is pretty small and I have been using varnish for quite some time or I would get out of memory quickly some the kernel OOM killer kicking1 it."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.chmouel.com/posts/"},{"@type":"ListItem","position":2,"name":"The trick to get your wordpress behind a reverse proxy","item":"https://blog.chmouel.com/2016/09/22/the-trick-to-get-your-wordpress-behind-a-reverse-proxy/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"The trick to get your wordpress behind a reverse proxy","name":"The trick to get your wordpress behind a reverse proxy","description":"I have been meaning to get this blog SSL protected for a while and since solution like letsencrypt makes it easy I have generated some SSL keys for my domain and configured it in apache.\nSo far so good, but the thing is my VM at my hosting provider is pretty small and I have been using varnish for quite some time or I would get out of memory quickly some the kernel OOM killer kicking1 it.","keywords":["Misc","Programming","Scripts"],"articleBody":"I have been meaning to get this blog SSL protected for a while and since solution like letsencrypt makes it easy I have generated some SSL keys for my domain and configured it in apache.\nSo far so good, but the thing is my VM at my hosting provider is pretty small and I have been using varnish for quite some time or I would get out of memory quickly some the kernel OOM killer kicking1 it.\nVarnish don’t do SSL so you have to do something else, I went ahead and used Nginx to provide my SSL endpoint which then would look like this :\n\nI could have done it with apache virtualhosts which look like this :\n\nI went finally for nginx since most people seems to say that it was more lean and quick for those kick of ssl accelerator job.\nSo far so good for the configuration, you can find those informations all over the internet, the nginx ssl configuration was a bit special so I can have the higher secure end of SSL encryption :\nNow the thing didn’t work very well when accessing the website, I could not see any of th medias including JS and SSL since they were served on the old non ssl url. I tried to force the wordpress configuration to serve SSL but I would end up in a http redirect loop.\nFinally I stumbled on this guy blog and looked at a hack to put in the wp-config.php file. I streamlined it to :\nif ( (!empty( $_SERVER['HTTP_X_FORWARDED_HOST'])) ||  (!empty( $_SERVER['HTTP_X_FORWARDED_FOR'])) ) {  $_SERVER['HTTPS'] = 'on'; } and that’s it, wordpress would then understand it would serve as HTTPS and would add its https url properly.\nHope this helps\n1 I had even a cron sometime ago to mysqlping my mysql server and restart it automatically if it was down since I was so sick of it\n","wordCount":"319","inLanguage":"en","datePublished":"2016-09-22T10:27:27Z","dateModified":"2016-09-22T10:27:27Z","author":{"@type":"Person","name":"chmouel"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.chmouel.com/2016/09/22/the-trick-to-get-your-wordpress-behind-a-reverse-proxy/"},"publisher":{"@type":"Organization","name":"Chmouel's blog","logo":{"@type":"ImageObject","url":"https://blog.chmouel.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.chmouel.com/ accesskey=h title="Chmouel's blog (Alt + H)">Chmouel's blog</a>
<span class=logo-switches></span></div><ul id=menu><li><a href=https://github.com/chmouel/ title=Github><span>Github</span></a></li><li><a href=https://photos.chmouel.com title=Photos><span>Photos</span></a></li><li><a href=https://app.strava.com/athletes/126695 title=Strava><span>Strava</span></a></li><li><a href=https://twitter.com/chmouel title=Twitter><span>Twitter</span></a></li><li><a href=https://redhat.com title=Work><span>Work</span></a></li><li><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>The trick to get your wordpress behind a reverse proxy</h1><div class=post-meta><span title="2016-09-22 10:27:27 +0000 UTC">September 22, 2016</span>&nbsp;|&nbsp;<a href=https://github.com/chmouel/blog/tree/main/content/posts/2016-09-22-the-trick-to-get-your-wordpress-behind-a-reverse-proxy.md rel="noopener noreferrer" target=_blank>Edit</a></div></header><div class=post-content><p>I have been meaning to get this blog SSL protected for a while and since solution like <a href=https://letsencrypt.org>letsencrypt</a> makes it easy I have generated some SSL keys for my domain  and configured it in apache.</p><p>So far so good, but the thing is my VM at my hosting provider is pretty small and I have been using <a href=https://varnish-cache.org/>varnish</a> for quite some time or I would get out of memory quickly some the kernel OOM killer kicking<a href=https://letsencrypt.org>1</a> it.</p><p>Varnish don&rsquo;t do SSL so you have to do something else, I went ahead and used Nginx to provide my SSL endpoint which then would look like this :</p><p><a href=/wp-content/uploads/2016/09/NGINX-Varnish-Apache.png></a></p><p>I could have done it with apache virtualhosts which look like this :</p><p><a href=/wp-content/uploads/2016/09/Apache-VirtualHosts-Varnish-SSL.png></a></p><p>I went finally for nginx since most people seems to say that it was more lean and quick for those kick of ssl accelerator job.</p><p>So far so good for the configuration, you can find those informations all over the internet, the nginx ssl configuration was a bit special so I can have the higher secure end of SSL encryption :</p><p>Now the thing didn&rsquo;t work very well when accessing the website, I could not see any of th medias including JS and SSL since they were served on the old non ssl url. I tried to force the wordpress configuration to serve SSL but I would end up in a http redirect loop.</p><p>Finally I stumbled on <a href=https://cmanios.wordpress.com/2014/04/12/nginx-https-reverse-proxy-to-wordpress-with-apache-http-and-different-port/>this guy blog</a> and looked at a hack to put in the wp-config.php file. I streamlined it to :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#ff79c6>if</span> ( (<span style=color:#ff79c6>!</span><span style=color:#ff79c6>empty</span>( <span style=color:#8be9fd;font-style:italic>$_SERVER</span>[<span style=color:#f1fa8c>&#39;HTTP_X_FORWARDED_HOST&#39;</span>])) <span style=color:#ff79c6>||</span>
</span></span><span style=display:flex><span>     (<span style=color:#ff79c6>!</span><span style=color:#ff79c6>empty</span>( <span style=color:#8be9fd;font-style:italic>$_SERVER</span>[<span style=color:#f1fa8c>&#39;HTTP_X_FORWARDED_FOR&#39;</span>])) ) {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>$_SERVER</span>[<span style=color:#f1fa8c>&#39;HTTPS&#39;</span>] <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;on&#39;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>and that&rsquo;s it, wordpress would then understand it would serve as HTTPS and would add its https url properly.</p><p>Hope this helps</p><p><a href=https://letsencrypt.org>1</a> I had even a cron sometime ago to mysqlping my mysql server and restart it automatically if it was down since I was so sick of it</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.chmouel.com/tags/misc/>Misc</a></li><li><a href=https://blog.chmouel.com/tags/programming/>Programming</a></li><li><a href=https://blog.chmouel.com/tags/scripts/>Scripts</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://blog.chmouel.com/>Chmouel's blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>