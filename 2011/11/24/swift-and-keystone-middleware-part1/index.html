<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Swift and Keystone middleware | Chmouel's blog</title><link rel=stylesheet href=https://blog.chmouel.com/assets/css/post.css><script defer src=https://blog.chmouel.com/assets/js/lbox.js></script>
<link rel=stylesheet href=https://blog.chmouel.com/assets/css/common.css></head><body><main><section id=bio><section id=img-wrapper><a class=site-title href=https://blog.chmouel.com/><img src=https://github.com/chmouel.png alt></a></section><section id=bio-wrapper><div id=text-wrapper><div class=centered><a href=/>Home</a>&nbsp; <a href=https://photos.chmouel.com>Photos</a>&nbsp; <a href=https://twitter.com/chmouel target=_blank>Twitter</a>&nbsp; <a href=https://github.com/chmouel target=_blank>Github</a>&nbsp; <a href=https://app.strava.com/athletes/126695 target=_blank>Strava</a>&nbsp; <a href=https://redhat.com target=_blank>Work</a></div><br><p>Chmouel Boudjnah's OpenSource developer Blog</p></div><div id=social-wrapper></div></section></section><br><section class=article><div class=article-header><h2 class=article-title>Swift and Keystone middleware</h2><div class=date>Thu Nov 24, 2011</div><div class=tags><a href=https://blog.chmouel.com/tags/Keystone class=tag>Keystone</a>
<a href=https://blog.chmouel.com/tags/Openstack class=tag>Openstack</a></div></div><div class=content><p>[NB: Much things has changed since I have written this article but keeping it here for info]</p><p>It seems that integrating Swift and Keystone together present some challenges to people and this is absolutely normal as there is a lot of changes going on. This is my attempt to document how everything is plugged together.</p><p>I am not going to explain how a middleware is supposed to work as this is nicely documented on Wikipedia :</p><p><a href=http://en.wikipedia.org/wiki/Middleware>http://en.wikipedia.org/wiki/Middleware</a></p><p>or how the auth middlewares works on Swift :</p><p><a href=http://swift.openstack.org/development_auth.html>http://swift.openstack.org/development_auth.html</a><br>or even how this is plugged inside Keystone :</p><p><a href=http://keystone.openstack.org/middleware_architecture.html>http://keystone.openstack.org/middleware_architecture.html</a></p><p>At first let&rsquo;s get some of the wordings right :</p><ul><li>A <strong>tenant</strong> in keystone is an <strong>account</strong> in swift.</li><li>A <strong>user</strong> in keystone is also a <strong>user</strong> in swift.</li><li>A <strong>role</strong> in keystone is a <strong>group</strong> in swift.</li></ul><p>Now that you keep this in mind let&rsquo;s walk-though how a request will<br>look like.</p><p>At first your user connect to keystone and says this is my username for this<br>tenant and here is the secret/api key, give me the endpoints for the<br>services and add a token to it. This will look like this in curl :</p><p>If successfully authenticated you get back in Json those public/internal urls<br>for swift so you are able to connect, here is some part of the replied request :</p><p>So now the clients is going to get the publicURL (or can be internal) with the token and able to give request to swift with it. Let&rsquo;s take the simple request which list the container,  this is a basic GET on the account :</p><p>which should come back by a 20* http code if that work.</p><p>What&rsquo;s happening here is that when you connect to swift it will pass it to the middleware to make sure we are able to have access with that token.</p><p>The middleware will take that token connect to keystone admin url with the admin token and pass that user token to be validated. The query looks like this in curl :</p><p><em><strong>note</strong>: localhost:35357 is the keystone admin url and 7XX is the admin token set in the configuration of the middleware.</em></p><p>if successful keystone will come back with a reply that look like this :</p><p>Let&rsquo;s step back before more Curl command and understand a thing about Swift, a user of an account in Swift by default don&rsquo;t have any rights at all but there is one user in that account  whose able to give ACL on containers for other users. In swift keystone middleware we call it an Operator.</p><p>The way the middleware knows which user is able to be admin on an account is by using the roles matching to whatever configuration we have on the middleware setting called :</p><p>since this user is part the SwiftOperator then it has access and he&rsquo;s allowed to do whatever he wants for that account like creating containers or giving ACL to other users.</p><p>So let&rsquo;s say we have a user called demo2 which is part of the demo account and have only the role Member to it and not SwiftOperator by default as we say before he will not be able to do much.</p><p>But if demo user give access to the group/role Memeber to a container via acl then demo2 will be able to do stuff on it.</p><p>We can all have fun with bunch of curl commands but since swift 1.4.7 the swift CLI tool have support for the auth server version 2.0 and allow you to connect to keystone for auth so we are going to use that instead.</p><p>Let first create a testcontainer and upload a file into it with our &lsquo;operator&rsquo; user :</p><p>now let&rsquo;s give access to the Member group for that container on reading :</p><p>and now if we try to read that file directly with demo2 it will be allowed :</p><p>Hope this make things a bit more clears how everything works, in the next part I am going to explain how the config files and packages will look like for installing keystone and swift.</p></div></section><footer class=footer><p><a href=https://github.com/chmouel/blog>&copy;</a> Chmouel Boudjnah - <a href=https://photos.chmouel.com><span class=fontawesome-inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M194.6 32H317.4c20.7.0 39 13.22 45.5 32.82L373.3 96H448c35.3.0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.35.0-64-28.7-64-64V160c0-35.3 28.65-64 64-64h74.7l10.4-31.18C155.6 45.22 173.9 32 194.6 32h0zM256 384c53 0 96-43 96-96 0-53.9-43-96-96-96-53.9.0-96 42.1-96 96 0 53 42.1 96 96 96z"/></svg></span></a>&nbsp;<a href=https://twitter.com/chmouel><span class=fontawesome-inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></span>
</a><a href=https://github.com/chmouel><span class=fontawesome-inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a></p></footer></main></body></html>