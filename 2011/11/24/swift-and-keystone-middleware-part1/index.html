<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Swift and Keystone middleware | Chmouel's blog</title><meta name=keywords content="Keystone,Openstack"><meta name=description content="[NB: Much things has changed since I have written this article but keeping it here for info]It seems that integrating Swiftand Keystonetogether present some challenges to people and this is absolutely normal as there is a lot of changes going on. This is my attempt to document how everything is plugged together.
I am not going to explain how a middleware is supposed to work as this is nicely documented on Wikipedia :"><meta name=author content><link rel=canonical href=https://blog.chmouel.com/2011/11/24/swift-and-keystone-middleware-part1/><link crossorigin=anonymous href=/assets/css/stylesheet.min.733d0ed34a984bf1936e895c1fb63452db516019da8c1c2e2f044719da64bee0.css integrity="sha256-cz0O00qYS/GTbolcH7Y0UttRYBnajBwuLwRHGdpkvuA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.chmouel.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.chmouel.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.chmouel.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.chmouel.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.chmouel.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Swift and Keystone middleware"><meta property="og:description" content="[NB: Much things has changed since I have written this article but keeping it here for info]It seems that integrating Swiftand Keystonetogether present some challenges to people and this is absolutely normal as there is a lot of changes going on. This is my attempt to document how everything is plugged together.
I am not going to explain how a middleware is supposed to work as this is nicely documented on Wikipedia :"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.chmouel.com/2011/11/24/swift-and-keystone-middleware-part1/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2011-11-24T09:20:39+00:00"><meta property="article:modified_time" content="2011-11-24T09:20:39+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Swift and Keystone middleware"><meta name=twitter:description content="[NB: Much things has changed since I have written this article but keeping it here for info]It seems that integrating Swiftand Keystonetogether present some challenges to people and this is absolutely normal as there is a lot of changes going on. This is my attempt to document how everything is plugged together.
I am not going to explain how a middleware is supposed to work as this is nicely documented on Wikipedia :"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.chmouel.com/posts/"},{"@type":"ListItem","position":2,"name":"Swift and Keystone middleware","item":"https://blog.chmouel.com/2011/11/24/swift-and-keystone-middleware-part1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Swift and Keystone middleware","name":"Swift and Keystone middleware","description":"[NB: Much things has changed since I have written this article but keeping it here for info]It seems that integrating Swiftand Keystonetogether present some challenges to people and this is absolutely normal as there is a lot of changes going on. This is my attempt to document how everything is plugged together.\nI am not going to explain how a middleware is supposed to work as this is nicely documented on Wikipedia :","keywords":["Keystone","Openstack"],"articleBody":"[NB: Much things has changed since I have written this article but keeping it here for info]It seems that integrating Swiftand Keystonetogether present some challenges to people and this is absolutely normal as there is a lot of changes going on. This is my attempt to document how everything is plugged together.\nI am not going to explain how a middleware is supposed to work as this is nicely documented on Wikipedia :\nhttp://en.wikipedia.org/wiki/Middlewareor how the auth middlewares works on Swift :\nhttp://swift.openstack.org/development_auth.htmlor even how this is plugged inside Keystone :\nhttp://keystone.openstack.org/middleware_architecture.htmlAt first let’s get some of the wordings right :\n A tenant in keystone is an account in swift. A user in keystone is also a user in swift. A role in keystone is a group in swift.  Now that you keep this in mind let’s walk-though how a request will\nlook like.\nAt first your user connect to keystone and says this is my username for this\ntenant and here is the secret/api key, give me the endpoints for the\nservices and add a token to it. This will look like this in curl :\nIf successfully authenticated you get back in Json those public/internal urls\nfor swift so you are able to connect, here is some part of the replied request :\nSo now the clients is going to get the publicURL (or can be internal) with the token and able to give request to swift with it. Let’s take the simple request which list the container, this is a basic GET on the account :\nwhich should come back by a 20* http code if that work.\nWhat’s happening here is that when you connect to swift it will pass it to the middleware to make sure we are able to have access with that token.\nThe middleware will take that token connect to keystone admin url with the admin token and pass that user token to be validated. The query looks like this in curl :\nnote: localhost:35357 is the keystone admin url and 7XX is the admin token set in the configuration of the middleware.\nif successful keystone will come back with a reply that look like this :\nLet’s step back before more Curl command and understand a thing about Swift, a user of an account in Swift by default don’t have any rights at all but there is one user in that account whose able to give ACL on containers for other users. In swift keystone middleware we call it an Operator.\nThe way the middleware knows which user is able to be admin on an account is by using the roles matching to whatever configuration we have on the middleware setting called :\nsince this user is part the SwiftOperator then it has access and he’s allowed to do whatever he wants for that account like creating containers or giving ACL to other users.\nSo let’s say we have a user called demo2 which is part of the demo account and have only the role Member to it and not SwiftOperator by default as we say before he will not be able to do much.\nBut if demo user give access to the group/role Memeber to a container via acl then demo2 will be able to do stuff on it.\nWe can all have fun with bunch of curl commands but since swift 1.4.7 the swift CLI tool have support for the auth server version 2.0 and allow you to connect to keystone for auth so we are going to use that instead.\nLet first create a testcontainer and upload a file into it with our ‘operator’ user :\nnow let’s give access to the Member group for that container on reading :\nand now if we try to read that file directly with demo2 it will be allowed :\nHope this make things a bit more clears how everything works, in the next part I am going to explain how the config files and packages will look like for installing keystone and swift.\n","wordCount":"673","inLanguage":"en","datePublished":"2011-11-24T09:20:39Z","dateModified":"2011-11-24T09:20:39Z","author":{"@type":"Person","name":"chmouel"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.chmouel.com/2011/11/24/swift-and-keystone-middleware-part1/"},"publisher":{"@type":"Organization","name":"Chmouel's blog","logo":{"@type":"ImageObject","url":"https://blog.chmouel.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.chmouel.com/ accesskey=h title="Chmouel's blog (Alt + H)">Chmouel's blog</a>
<span class=logo-switches></span></div><ul id=menu><li><a href=https://github.com/chmouel/ title=Github><span>Github</span></a></li><li><a href=https://photos.chmouel.com title=Photos><span>Photos</span></a></li><li><a href=https://app.strava.com/athletes/126695 title=Strava><span>Strava</span></a></li><li><a href=https://twitter.com/chmouel title=Twitter><span>Twitter</span></a></li><li><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Swift and Keystone middleware</h1><div class=post-meta><span title="2011-11-24 09:20:39 +0000 UTC">November 24, 2011</span>&nbsp;|&nbsp;<a href=https://github.com/chmouel/blog/tree/main/content/posts/2011-11-24-swift-and-keystone-middleware-part1.md rel="noopener noreferrer" target=_blank>Edit</a></div></header><div class=post-content><p>[NB: Much things has changed since I have written this article but keeping it here for info]</p><p>It seems that integrating Swift and Keystone together present some challenges to people and this is absolutely normal as there is a lot of changes going on. This is my attempt to document how everything is plugged together.</p><p>I am not going to explain how a middleware is supposed to work as this is nicely documented on Wikipedia :</p><p><a href=http://en.wikipedia.org/wiki/Middleware>http://en.wikipedia.org/wiki/Middleware</a></p><p>or how the auth middlewares works on Swift :</p><p><a href=http://swift.openstack.org/development_auth.html>http://swift.openstack.org/development_auth.html</a><br>or even how this is plugged inside Keystone :</p><p><a href=http://keystone.openstack.org/middleware_architecture.html>http://keystone.openstack.org/middleware_architecture.html</a></p><p>At first let&rsquo;s get some of the wordings right :</p><ul><li>A <strong>tenant</strong> in keystone is an <strong>account</strong> in swift.</li><li>A <strong>user</strong> in keystone is also a <strong>user</strong> in swift.</li><li>A <strong>role</strong> in keystone is a <strong>group</strong> in swift.</li></ul><p>Now that you keep this in mind let&rsquo;s walk-though how a request will<br>look like.</p><p>At first your user connect to keystone and says this is my username for this<br>tenant and here is the secret/api key, give me the endpoints for the<br>services and add a token to it. This will look like this in curl :</p><p>If successfully authenticated you get back in Json those public/internal urls<br>for swift so you are able to connect, here is some part of the replied request :</p><p>So now the clients is going to get the publicURL (or can be internal) with the token and able to give request to swift with it. Let&rsquo;s take the simple request which list the container,  this is a basic GET on the account :</p><p>which should come back by a 20* http code if that work.</p><p>What&rsquo;s happening here is that when you connect to swift it will pass it to the middleware to make sure we are able to have access with that token.</p><p>The middleware will take that token connect to keystone admin url with the admin token and pass that user token to be validated. The query looks like this in curl :</p><p><em><strong>note</strong>: localhost:35357 is the keystone admin url and 7XX is the admin token set in the configuration of the middleware.</em></p><p>if successful keystone will come back with a reply that look like this :</p><p>Let&rsquo;s step back before more Curl command and understand a thing about Swift, a user of an account in Swift by default don&rsquo;t have any rights at all but there is one user in that account  whose able to give ACL on containers for other users. In swift keystone middleware we call it an Operator.</p><p>The way the middleware knows which user is able to be admin on an account is by using the roles matching to whatever configuration we have on the middleware setting called :</p><p>since this user is part the SwiftOperator then it has access and he&rsquo;s allowed to do whatever he wants for that account like creating containers or giving ACL to other users.</p><p>So let&rsquo;s say we have a user called demo2 which is part of the demo account and have only the role Member to it and not SwiftOperator by default as we say before he will not be able to do much.</p><p>But if demo user give access to the group/role Memeber to a container via acl then demo2 will be able to do stuff on it.</p><p>We can all have fun with bunch of curl commands but since swift 1.4.7 the swift CLI tool have support for the auth server version 2.0 and allow you to connect to keystone for auth so we are going to use that instead.</p><p>Let first create a testcontainer and upload a file into it with our &lsquo;operator&rsquo; user :</p><p>now let&rsquo;s give access to the Member group for that container on reading :</p><p>and now if we try to read that file directly with demo2 it will be allowed :</p><p>Hope this make things a bit more clears how everything works, in the next part I am going to explain how the config files and packages will look like for installing keystone and swift.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.chmouel.com/tags/keystone/>Keystone</a></li><li><a href=https://blog.chmouel.com/tags/openstack/>Openstack</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://blog.chmouel.com/>Chmouel's blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>