<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Using ProxyCommand with OpenSSH and a Bastion server. | Chmouel's blog</title><meta name=keywords content="Scripts"><meta name=description content="So at work we have to use a bastion hostfor all our connections to servers to be able to get called PCI compliant. This kind of stuff could be a pain to use when you have to use another host to do RSYNC/SCP or other stuff that need direct transfer to workstation.
Thankfully OpenSSH is very flexible and have multiple options to easy the pain. If you add this to your ~/."><meta name=author content><link rel=canonical href=https://blog.chmouel.com/2009/02/08/proxycommand-ssh-bastion-proxy/><link crossorigin=anonymous href=/assets/css/stylesheet.min.286ffbab1cfdcf5c35ec0edbfc67759192b408de6939c558bbd4a964ca89f552.css integrity="sha256-KG/7qxz9z1w17A7b/Gd1kZK0CN5pOcVYu9SpZMqJ9VI=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.chmouel.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.chmouel.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.chmouel.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.chmouel.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.chmouel.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Using ProxyCommand with OpenSSH and a Bastion server."><meta property="og:description" content="So at work we have to use a bastion hostfor all our connections to servers to be able to get called PCI compliant. This kind of stuff could be a pain to use when you have to use another host to do RSYNC/SCP or other stuff that need direct transfer to workstation.
Thankfully OpenSSH is very flexible and have multiple options to easy the pain. If you add this to your ~/."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.chmouel.com/2009/02/08/proxycommand-ssh-bastion-proxy/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2009-02-08T12:21:38+00:00"><meta property="article:modified_time" content="2009-02-08T12:21:38+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using ProxyCommand with OpenSSH and a Bastion server."><meta name=twitter:description content="So at work we have to use a bastion hostfor all our connections to servers to be able to get called PCI compliant. This kind of stuff could be a pain to use when you have to use another host to do RSYNC/SCP or other stuff that need direct transfer to workstation.
Thankfully OpenSSH is very flexible and have multiple options to easy the pain. If you add this to your ~/."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.chmouel.com/posts/"},{"@type":"ListItem","position":2,"name":"Using ProxyCommand with OpenSSH and a Bastion server.","item":"https://blog.chmouel.com/2009/02/08/proxycommand-ssh-bastion-proxy/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Using ProxyCommand with OpenSSH and a Bastion server.","name":"Using ProxyCommand with OpenSSH and a Bastion server.","description":"So at work we have to use a bastion hostfor all our connections to servers to be able to get called PCI compliant. This kind of stuff could be a pain to use when you have to use another host to do RSYNC/SCP or other stuff that need direct transfer to workstation.\nThankfully OpenSSH is very flexible and have multiple options to easy the pain. If you add this to your ~/.","keywords":["Scripts"],"articleBody":"So at work we have to use a bastion hostfor all our connections to servers to be able to get called PCI compliant. This kind of stuff could be a pain to use when you have to use another host to do RSYNC/SCP or other stuff that need direct transfer to workstation.\nThankfully OpenSSH is very flexible and have multiple options to easy the pain. If you add this to your ~/.ssh/config :\n Host bastion\nHostname IP_ADDRESS_OF_BASTION_SERVERUser YOUR_USERNAMEProxyCommand none\nControlMaster auto\nControlPath ~/.ssh/master-%r@%h:%p\nHost *\nProxyCommand ssh -qax bastion ’nc -w 600 %h %p'\n This will allow you to pass all SSH requests to the bastion server.\nI have experimented with different options and this seems to be most efficient way. The ControlMaster ControlPath is to speed up the connections by not reopening a tcp socket all the time to the bastion server. This seems to cause problems with the OpenSSH version shipped with some distros (ie: Fedora) so you may want to remove it if you experience problems. For the ProxyCommand there is way to use cat like this :\n ProxyCommand ssh bastion ’exec 3/dev/tcp/%h/22;(cat \u00263'\n but the cat processes seems to hang in memory on the bastion server so netcat seems a better option. I heard that tcpconnect from the tcputils package should make things smoother but I haven’t tried that.\nI have other options in my SSH configuration to allow to be less verbose see ssh_config(5) manpage for detailed description of each of these options :\n Host *\nForwardAgent yes\nGSSAPIAuthentication no\nVerifyHostKeyDNS no\nStrictHostKeyChecking no\nHashKnownHosts no\nTCPKeepAlive yes\nServerAliveInterval 600\n By the way forgot to mention you would need to have SSH key exchange configured with the bastion server with a SSH agent runing (these days all distros should do that by default) to don’t have to type the password of your username on bastion server.\nI have heard there is way to do that on Windows with putty and plink but I haven’t tried that see this post hereabout it.\n","wordCount":"339","inLanguage":"en","datePublished":"2009-02-08T12:21:38Z","dateModified":"2009-02-08T12:21:38Z","author":{"@type":"Person","name":"chmouel"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.chmouel.com/2009/02/08/proxycommand-ssh-bastion-proxy/"},"publisher":{"@type":"Organization","name":"Chmouel's blog","logo":{"@type":"ImageObject","url":"https://blog.chmouel.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.chmouel.com/ accesskey=h title="Chmouel's blog (Alt + H)">Chmouel's blog</a>
<span class=logo-switches></span></div><ul id=menu><li><a href=https://github.com/chmouel/ title=Github><span>Github</span></a></li><li><a href=https://photos.chmouel.com title=Photos><span>Photos</span></a></li><li><a href=https://app.strava.com/athletes/126695 title=Strava><span>Strava</span></a></li><li><a href=https://twitter.com/chmouel title=Twitter><span>Twitter</span></a></li><li><a href=https://redhat.com title=Work><span>Work</span></a></li><li><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Using ProxyCommand with OpenSSH and a Bastion server.</h1><div class=post-meta><span title="2009-02-08 12:21:38 +0000 UTC">February 8, 2009</span>&nbsp;|&nbsp;<a href=https://github.com/chmouel/blog/tree/main/content/posts/2009-02-08-proxycommand-ssh-bastion-proxy.md rel="noopener noreferrer" target=_blank>Edit</a></div></header><div class=post-content><p>So at work we have to use a bastion host for all our connections to servers to be able to get called <a href=http://www.pcicomplianceguide.org/>PCI</a> compliant. This kind of stuff could be a pain to use when you have to use another host to do RSYNC/SCP or other stuff that need direct transfer to workstation.</p><p>Thankfully OpenSSH is very flexible and have multiple options to easy the pain. If you add this to your ~/.ssh/config :</p><blockquote><p>Host bastion<br>Hostname IP_ADDRESS_OF_BASTION_SERVER<br>User YOUR_USERNAME<br>ProxyCommand none<br>ControlMaster auto<br>ControlPath ~/.ssh/master-%r@%h:%p</p><p>Host *<br>ProxyCommand ssh -qax bastion &rsquo;nc -w 600 %h %p'</p></blockquote><p>This will allow you to pass all SSH requests to the bastion server.</p><p>I have experimented with different options and this seems to be most efficient way. The ControlMaster ControlPath is to speed up the connections by not reopening a tcp socket all the time to the bastion server. This seems to cause problems with the OpenSSH version shipped with some distros (ie: Fedora) so you may want to remove it if you experience problems. For the ProxyCommand there is way to use cat like this :</p><blockquote><p>ProxyCommand ssh bastion &rsquo;exec 3&lt;>/dev/tcp/%h/22;(cat &lt;&3 & );cat >&3'</p></blockquote><p>but the cat processes seems to hang in memory on the bastion server so netcat seems a better option.  I heard that tcpconnect from the tcputils package should make things smoother but I haven&rsquo;t tried that.</p><p>I have other options in my SSH configuration to allow to be less verbose see <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ssh_config">ssh_config(5)</a> manpage for detailed description of each of these options :</p><blockquote><p>Host *<br>ForwardAgent yes<br>GSSAPIAuthentication no<br>VerifyHostKeyDNS no<br>StrictHostKeyChecking no<br>HashKnownHosts no<br>TCPKeepAlive yes<br>ServerAliveInterval 600</p></blockquote><p>By the way forgot to mention you would need to have SSH key exchange configured with the bastion server with a SSH agent runing (these days all distros should do that by default) to don&rsquo;t have to type the password of your username on bastion server.</p><p>I have heard there is way to do that on Windows with putty and plink but I haven&rsquo;t tried that see this post here about it.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.chmouel.com/tags/scripts/>Scripts</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://blog.chmouel.com/>Chmouel's blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>