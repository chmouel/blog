<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>User namespaces with Buildah and OpenShift Pipelines | Chmouel's blog</title><link rel=stylesheet href=https://blog.chmouel.com/assets/css/post.css><script defer src=https://blog.chmouel.com/assets/js/lbox.js></script>
<link rel=stylesheet href=https://blog.chmouel.com/assets/css/common.css></head><body><main><section id=bio><section id=img-wrapper><a class=site-title href=https://blog.chmouel.com/><img src=/static/chmouel.png alt></a></section><section id=bio-wrapper><div id=text-wrapper><div class=centered><a href=/>Home</a>&nbsp; <a href=https://photos.chmouel.com>Photos</a>&nbsp; <a href=https://twitter.com/chmouel target=_blank>Twitter</a>&nbsp; <a href=https://github.com/chmouel target=_blank>Github</a>&nbsp; <a href=https://app.strava.com/athletes/126695 target=_blank>Strava</a>&nbsp; <a href=https://redhat.com target=_blank>Work</a></div><br><p>Chmouel Boudjnah's OpenSource developer Blog</p></div><div id=social-wrapper></div></section></section><br><section class=article><div class=article-header><h2 class=article-title>User namespaces with Buildah and OpenShift Pipelines</h2><div class=date>Tue Jan 25, 2022</div><div class=tags></div></div><div class=content><p>In 2022 one of the hottest topic around CI is how to secure it every steps along the way.</p><p>The so-called supply chain attacks have been more and more an attack vector for bad actor whereas providers need to make sure every piece of the Integration is secure.</p><p>One area that was identified as something we can improve with Openshift and containers in general is when running as root on the container <em>may</em> expose the host and process in that container may be able to mingle with other resources.</p><p>And this is a problem for us at the OpenShift pipelines team since this is what our shipped buildah ClusterTask does by default.</p><p>Ideally we would like to run everything rootless with a randomized user id, like what Openshift does by default. But there are some use-cases needing to run as root on the container but still be secure on the host.</p><p>In this article we will focus on Buildah but some of those techniques can be reused for different workloads, bear in mind that some of those technologies can be pretty bleeding edge and you may encounter some unexpected side effects, but for the sake of a secure pipeline I would encourage you to try this out and see how it works out for you.</p><h2 id=running-as-root-in-a-user-namespace><strong>Running as root in a user namespace</strong></h2><p>Running in a user namespace is when your are running the container as root (user id 0) but as user on the host.</p><p>OpenShift is using CRI-O as its container engine. And CRI-O has now a workload feature to be able to let the pod know it wants to run <a href=https://github.com/cri-o/cri-o/blob/main/docs/crio.conf.5.md#crioruntimeworkloads-table>“user namespaced”</a>.</p><p>User namespaces is not a new feature; it has been here for a while, see for example this <a href=https://lwn.net/Articles/532593/>2013 article</a> from the lwn introducing it. But it took some time to come to RHEL (from RHEL8) and integrated into OpenShift (support was added in Openshift 4.10). If you want to try this feature manually you can refer to <a href=https://www.redhat.com/sysadmin/building-container-namespaces>this article</a> explaining how it works .</p><p>To run as a user in a namespace with Openshift Pipelines you need to be able to pass the annotations expected by CRIO to get the pods running user namespaced.</p><p>You can directly edit the buildah ClusterTask with “oc edit clustertask buildah” to add this to all users, or export the clustertask as a task to a specific Namespace.</p><p>With the latest tkn create from feature you can easily automate it :</p><p>And add the annotations to the task :</p><p>Now if you are running the (currently unreleased) latest Openshift Pipelines 1.7 on OpenShift 4.10, you will see your buildah container running like before as root.</p><p>But if you adventure yourself behind the scene on the host of the pod :</p><p>OpenShift and CRIO did their magic and ran your pod in a “user namespace”.</p><h2 id=running-as-rootless-in-container><strong>Running as rootless in container</strong></h2><p>To be able to run as rootless inside a container; where you run as a user inside the container, you need your container to do some setup to add the subuid and subgid provided from the latest shadow-utils package.</p><p>Thankfully the public image based on Red Hat UBI has everything already setup for us in its <a href="https://catalog.redhat.com/software/containers/ubi8/buildah/602686f7b16b1eb2e30807ee?container-tabs=dockerfile">Containerfile</a></p><p>You have an extra step to do tho, you need to “force” running the container as the “build” user, because if we start to leave it to the default it will be “randomed” and would not have the setup needed to run as non-root.</p><p>Edit directly or export to a specific namespace the buildah clustertask as described in the previous section.
Add this securityContext to each <a href=https://github.com/tektoncd/operator/blob/main/cmd/openshift/operator/kodata/tekton-addon/addons/02-clustertasks/buildah/buildah-task.yaml#L63>build</a> and <a href=https://github.com/tektoncd/operator/blob/main/cmd/openshift/operator/kodata/tekton-addon/addons/02-clustertasks/buildah/buildah-task.yaml#L75>push</a> steps :</p><p>Since we are now going to be building as user, buildah will keep its image caching in <strong>/home/build/.local/cache</strong> so instead of volume mounting <strong>/var/lib/containers</strong> we are going to change the <strong>mountPath</strong> on build and push steps to the user one :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>volumeMounts</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>name</span>: varlibcontainers
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>mountPath</span>: /home/build/.local/share/containers
</span></span></code></pre></div><p>And for demo purpose I have added this line at the beginning of the script task :</p><p><code>echo "Running as USER ID id"</code></p><p>I have then created a <a href=https://github.com/tektoncd/pipeline/blob/main/docs/workspaces.md#configmap>ConfigMap workspace</a> with a sample dockerfile and a sample taskrun to be able to test it.</p><p>When running it, I can see my image is running as user :</p><h2 id=more-security-with-a-custom-scc>More security with a custom SCC</h2><p>Now these steps are working because currently on Openshift Pipelines we make all taskrun/pipelinerun running automatically as the pipelines serviceAccount which has the pipelines SecurityContext that allows running as any user.</p><p>We have added those rights to have it easy to to migrate pipelines that needs to be run or build as root, but if you like to further lock down your installation you can only allow running container as the user 1000 if the pod is asking (or the container image forces it) for it and don’t let the container running as root by default.</p><p>To do so you need to edit the pipelines-scc and modify the runAsUser and seLinuxContext section to MustRunAs to uid 1000 :</p><p>The pipeline serviceaccount will only allow running images as user 1000 and not as root anymore, if the images are not running as 1000 they will be randomed out as user id.</p><h2 id=templates-examples>Templates examples</h2><p>This gist reference all the files I am mentionned int his article</p><ul><li><p>Buildah.yaml force running as user build :</p><p><a href=https://gist.github.com/chmouel/8242806100ffa7164bb63d7d5b0a593d#file-buildah-task-yaml>https://gist.github.com/chmouel/8242806100ffa7164bb63d7d5b0a593d#file-buildah-task-yaml</a></p></li><li><p>Taskrun and Dockerfile configmap workspace:</p></li></ul><p><a href=https://gist.github.com/chmouel/8242806100ffa7164bb63d7d5b0a593d#file-buildah-taskrun-configmap-yaml>https://gist.github.com/chmouel/8242806100ffa7164bb63d7d5b0a593d#file-buildah-taskrun-configmap-yaml</a></p><ul><li><p>Modified scc only allow running as user 1000 :</p><p><a href=https://gist.github.com/chmouel/8242806100ffa7164bb63d7d5b0a593d#file-scc-runasuser-drop-anyuid-yaml>https://gist.github.com/chmouel/8242806100ffa7164bb63d7d5b0a593d#file-scc-runasuser-drop-anyuid-yaml</a></p></li></ul></div></section><footer class=footer><p><a href=https://github.com/chmouel/blog>&copy;</a> Chmouel Boudjnah - <a href=https://photos.chmouel.com><span class=fontawesome-inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M194.6 32H317.4c20.7.0 39 13.22 45.5 32.82L373.3 96H448c35.3.0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.35.0-64-28.7-64-64V160c0-35.3 28.65-64 64-64h74.7l10.4-31.18C155.6 45.22 173.9 32 194.6 32h0zM256 384c53 0 96-43 96-96 0-53.9-43-96-96-96-53.9.0-96 42.1-96 96 0 53 42.1 96 96 96z"/></svg></span></a>&nbsp;<a href=https://twitter.com/chmouel><span class=fontawesome-inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></span>
</a><a href=https://github.com/chmouel><span class=fontawesome-inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a></p></footer></main></body></html>