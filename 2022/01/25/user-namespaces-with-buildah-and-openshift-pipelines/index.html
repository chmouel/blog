<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>User namespaces with Buildah and OpenShift Pipelines | Chmouel's blog</title>
<meta name=keywords content><meta name=description content="In 2022 one of the hottest topic around CI is how to secure it every steps along the way.
The so-called supply chain attacks have been more and more an attack vector for bad actor whereas providers need to make sure every piece of the Integration is secure.
One area that was identified as something we can improve with Openshift and containers in general is when running as root on the container may expose the host and process in that container may be able to mingle with other resources."><meta name=author content><link rel=canonical href=https://blog.chmouel.com/2022/01/25/user-namespaces-with-buildah-and-openshift-pipelines/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://blog.chmouel.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.chmouel.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.chmouel.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.chmouel.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.chmouel.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://blog.chmouel.com/2022/01/25/user-namespaces-with-buildah-and-openshift-pipelines/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://blog.chmouel.com/2022/01/25/user-namespaces-with-buildah-and-openshift-pipelines/"><meta property="og:site_name" content="Chmouel's blog"><meta property="og:title" content="User namespaces with Buildah and OpenShift Pipelines"><meta property="og:description" content="In 2022 one of the hottest topic around CI is how to secure it every steps along the way.
The so-called supply chain attacks have been more and more an attack vector for bad actor whereas providers need to make sure every piece of the Integration is secure.
One area that was identified as something we can improve with Openshift and containers in general is when running as root on the container may expose the host and process in that container may be able to mingle with other resources."><meta property="og:locale" content="en-GB"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-25T10:07:07+00:00"><meta property="article:modified_time" content="2022-01-25T10:07:07+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="User namespaces with Buildah and OpenShift Pipelines"><meta name=twitter:description content="In 2022 one of the hottest topic around CI is how to secure it every steps along the way.
The so-called supply chain attacks have been more and more an attack vector for bad actor whereas providers need to make sure every piece of the Integration is secure.
One area that was identified as something we can improve with Openshift and containers in general is when running as root on the container may expose the host and process in that container may be able to mingle with other resources."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.chmouel.com/posts/"},{"@type":"ListItem","position":2,"name":"User namespaces with Buildah and OpenShift Pipelines","item":"https://blog.chmouel.com/2022/01/25/user-namespaces-with-buildah-and-openshift-pipelines/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"User namespaces with Buildah and OpenShift Pipelines","name":"User namespaces with Buildah and OpenShift Pipelines","description":"In 2022 one of the hottest topic around CI is how to secure it every steps along the way.\nThe so-called supply chain attacks have been more and more an attack vector for bad actor whereas providers need to make sure every piece of the Integration is secure.\nOne area that was identified as something we can improve with Openshift and containers in general is when running as root on the container may expose the host and process in that container may be able to mingle with other resources.\n","keywords":[],"articleBody":"In 2022 one of the hottest topic around CI is how to secure it every steps along the way.\nThe so-called supply chain attacks have been more and more an attack vector for bad actor whereas providers need to make sure every piece of the Integration is secure.\nOne area that was identified as something we can improve with Openshift and containers in general is when running as root on the container may expose the host and process in that container may be able to mingle with other resources.\nAnd this is a problem for us at the OpenShift pipelines team since this is what our shipped buildah ClusterTask does by default.\nIdeally we would like to run everything rootless with a randomized user id, like what Openshift does by default. But there are some use-cases needing to run as root on the container but still be secure on the host.\nIn this article we will focus on Buildah but some of those techniques can be reused for different workloads, bear in mind that some of those technologies can be pretty bleeding edge, and you may encounter some unexpected side effects, but for the sake of a secure pipeline I would encourage you to try this out and see how it works out for you.\nRunning as root in a user namespace Running in a user namespace is when you are running the container as root (user id 0) but as user on the host.\nOpenShift is using CRI-O as its container engine. And CRI-O has now a workload feature to be able to let the pod know it wants to run “user namespaced”.\nUser namespaces is not a new feature; it has been here for a while, see for example this 2013 article from the lwn introducing it. But it took some time to be included in RHEL (from RHEL8) and integrated into OpenShift (support was added in Openshift 4.10). If you want to try this feature manually you can refer to this article explaining how it works .\nTo run as a user in a namespace with Openshift Pipelines you need to be able to pass the annotations expected by CRIO to get the pods running user namespaced.\nYou can directly edit the buildah ClusterTask with “oc edit clustertask buildah” to add this to all users, or export the clustertask as a task to a specific Namespace.\nWith the latest tkn create from feature you can easily automate it :\noc new-project test $ tkn task create --from=buildah $ oc edit task buildah And add the annotations to the task :\nannotations: io.kubernetes.cri-o.userns-mode: \"auto\" io.openshift.builder: \"true\" Now if you are running the (currently unreleased) latest Openshift Pipelines 1.7 on OpenShift 4.10, you will see your buildah container running like before as root.\nBut if you adventure yourself behind the scene on the host of the pod :\n# get the nodename where the buildah pod is with \"oc get pod -o wide\" $ oc debug nodes/nodename $ chroot /host $ lsns -t user OpenShift and CRIO did their magic and ran your pod in a “user namespace”.\nRunning as rootless in container To be able to run as rootless inside a container; where you run as a user inside the container, you need your container to do some setup to add the subuid and subgid provided from the latest shadow-utils package.\nThankfully the public image based on Red Hat UBI has everything already setup for us in its Containerfile\nYou have an extra step to take tho, you need to “force” running the container as the “build” user, because if we start to leave it to the default it will be “randomed” and would not have the setup needed to run as non-root.\nEdit directly or export to a specific namespace the buildah clustertask as described in the previous section. Add this securityContext to each build and push steps :\nsecurityContext: runAsUser: 1000 Since we are now going to be building as user, buildah will keep its image caching in /home/build/.local/cache so instead of volume mounting /var/lib/containers we are going to change the mountPath on build and push steps to the user one :\nvolumeMounts: - name: varlibcontainers mountPath: /home/build/.local/share/containers And for demo purpose I have added this line at the beginning of the script task :\necho \"Running as USER ID id\"\nI have then created a ConfigMap workspace with a sample dockerfile and a sample taskrun to be able to test it.\nWhen running it, I can see my image is running as user :\n% tkn tr logs -Lf buildah-run [build] ++ id [build] Running as USER ID uid=1000(build) gid=1000(build) groups=1000(build),1000690000 [build] + echo 'Running as USER ID uid=1000(build) gid=1000(build) groups=1000(build),1000690000' [build] + buildah --storage-driver=vfs bud --format=oci --tls-verify=true --no-cache -f ./Dockerfile -t image-registry.openshift-image-registry.svc:5000/test/buildahuser . [build] STEP 1: FROM registry.access.redhat.com/ubi8/ubi AS buildah-runner [build] Getting image source signatures [build] Checking if image destination supports signatures [build] Copying blob sha256:adffa69631469a649556cee5b8456f184928818064aac82106bd08bd62e51d4e [build] Copying blob sha256:26f1167feaf74177f9054bf26ac8775a4b188f25914e23bda9574ef2a759cce4 [build] Copying config sha256:fca12da1dc30ed8e7d03afb84b287fc695673fff9c04bfcb2ff404b558670a36 [build] Writing manifest to image destination [build] Storing signatures [build] STEP 2: RUN dnf -y update \u0026\u0026 dnf -y install git \u0026\u0026 dnf clean all [build] Updating Subscription Management repositories. […] More security with a custom SCC Now these steps are working because currently on Openshift Pipelines we make all taskrun/pipelinerun running automatically as the pipelines serviceAccount which has the pipelines SecurityContext that allows running as any user.\nWe have added those rights to have it easy to to migrate pipelines that needs to be run or build as root, but if you like to further lock down your installation you can only allow running container as the user 1000 if the pod is asking (or the container image forces it) for it and don’t let the container running as root by default.\nTo do so you need to edit the pipelines-scc and modify the runAsUser and seLinuxContext section to MustRunAs to uid 1000 :\nrunAsUser: type: MustRunAs uid: 1000 seLinuxContext: type: MustRunAs The pipeline serviceaccount will only allow running images as user 1000 and not as root anymore, if the images are not running as 1000 they will berandomed out as user id.\nTemplates examples This gist reference all the files I am mentioned int his article\nBuildah.yaml force running as user build : https://gist.github.com/chmouel/8242806100ffa7164bb63d7d5b0a593d#file-buildah-task-yaml\nTaskrun and Dockerfile configmap workspace: https://gist.github.com/chmouel/8242806100ffa7164bb63d7d5b0a593d#file-buildah-taskrun-configmap-yaml\nModified scc only allow running as user 1000: https://gist.github.com/chmouel/8242806100ffa7164bb63d7d5b0a593d#file-scc-runasuser-drop-anyuid-yaml\n","wordCount":"1061","inLanguage":"en","datePublished":"2022-01-25T10:07:07Z","dateModified":"2022-01-25T10:07:07Z","author":{"@type":"Person","name":"chmouel"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.chmouel.com/2022/01/25/user-namespaces-with-buildah-and-openshift-pipelines/"},"publisher":{"@type":"Organization","name":"Chmouel's blog","logo":{"@type":"ImageObject","url":"https://blog.chmouel.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.chmouel.com/ accesskey=h title="Chmouel's blog (Alt + H)">Chmouel's blog</a>
<span class=logo-switches><ul class=lang-switch></ul></span></div><ul id=menu><li><a href=https://photos.chmouel.com title=camera><svg viewBox="0 0 512 512"><title>Photo Website</title><path d="M149.1 64.8 138.7 96H64C28.7 96 0 124.7.0 160V416c0 35.3 28.7 64 64 64H448c35.3.0 64-28.7 64-64V160c0-35.3-28.7-64-64-64H373.3L362.9 64.8C356.4 45.2 338.1 32 317.4 32H194.6c-20.7.0-39 13.2-45.5 32.8zM256 192a96 96 0 110 192 96 96 0 110-192z"/></svg>
<span></span></a></li><li><a href=https://github.com/chmouel/ title=GitHub><svg viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
<span></span></a></li><li><a href=https://fosstodon.org/@chmouel title=Mastodon><svg viewBox="0 0 448 512"><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>
<span></span></a></li><li><a href=https://redhat.com title=redhat><svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" id="b6bdd2b4-52ab-488a-9a30-1e6d1d7dd2d4" data-name="Layer 1" viewBox="0 0 192.30001 146" sodipodi:docname="logo.svg" width="192.3" height="146" inkscape:version="0.92.5 (2060ec1f9f, 2020-04-08)"><sodipodi:namedview bordercolor="#666666" borderopacity="1" objecttolerance="10" gridtolerance="10" guidetolerance="10" inkscape:pageopacity="0" inkscape:pageshadow="2" inkscape:window-width="1920" inkscape:window-height="1007" id="namedview13" showgrid="false" fit-margin-top="1" fit-margin-right="1" fit-margin-bottom="1" fit-margin-left="1" inkscape:zoom=".45930043" inkscape:cx="306.89999" inkscape:cy="73" inkscape:window-x="0" inkscape:window-y="0" inkscape:window-maximized="1" inkscape:current-layer="b6bdd2b4-52ab-488a-9a30-1e6d1d7dd2d4"/><title>Red Hat</title><path class="a737459c-e8c7-4afa-8008-f6cfd15ccda2" d="m128 84c12.5.0 30.6-2.6 30.6-17.5a19.53 19.53.0 00-.3-3.4L150.9 30.7C149.2 23.6 147.7 20.3 135.2 14.1 125.5 9.1 104.4 1 98.1 1 92.2 1 90.5 8.5 83.6 8.5 76.9 8.5 72 2.9 65.7 2.9c-6 0-9.9 4.1-12.9 12.5.0.0-8.4 23.7-9.5 27.2a6.15 6.15.0 00-.2 1.9C43 53.7 79.3 83.9 128 84m32.5-11.4c1.7 8.2 1.7 9.1 1.7 10.1.0 14-15.7 21.8-36.4 21.8C79 104.5 38.1 77.1 38.1 59a18.35 18.35.0 011.5-7.3C22.8 52.5 1 55.5 1 74.7 1 106.2 75.6 145 134.6 145c45.3.0 56.7-20.5 56.7-36.7.0-12.7-11-27.1-30.8-35.7" id="path8" inkscape:connector-curvature="0"/><path d="m160.5 72.6c1.7 8.2 1.7 9.1 1.7 10.1.0 14-15.7 21.8-36.4 21.8C79 104.5 38.1 77.1 38.1 59a18.35 18.35.0 011.5-7.3l3.7-9.1a6.15 6.15.0 00-.2 1.9c0 9.2 36.3 39.4 84.9 39.4 12.5.0 30.6-2.6 30.6-17.5A19.53 19.53.0 00158.3 63z" id="path10" inkscape:connector-curvature="0"/></svg>
<span></span></a></li><li><a href=https://app.strava.com/athletes/126695 title=Strava><svg viewBox="0 0 384 512"><path d="M158.4.0 7 292h89.2l62.2-116.1L220.1 292h88.5zm150.2 292-43.9 88.2-44.6-88.2h-67.6l112.2 220 111.5-220z"/></svg>
<span></span></a></li><li><a href=https://twitter.com/chmouel title=Twitter><svg viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
<span></span></a></li><li><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">User namespaces with Buildah and OpenShift Pipelines</h1><div class=post-meta><span title='2022-01-25 10:07:07 +0000 UTC'>January 25, 2022</span>&nbsp;|&nbsp;<a href=https://github.com/chmouel/blog/tree/main/content/posts/2022-01-25-user-namespaces-with-buildah-and-openshift-pipelines.md rel="noopener noreferrer" target=_blank>Edit</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#running-as-root-in-a-user-namespace aria-label="Running as root in a user namespace">Running as root in a user namespace</a></li><li><a href=#running-as-rootless-in-container aria-label="Running as rootless in container">Running as rootless in container</a></li><li><a href=#more-security-with-a-custom-scc aria-label="More security with a custom SCC">More security with a custom SCC</a></li><li><a href=#templates-examples aria-label="Templates examples">Templates examples</a></li></ul></div></details></div><div class=post-content><p>In 2022 one of the hottest topic around CI is how to secure it every steps along the way.</p><p>The so-called supply chain attacks have been more and more an attack vector for bad actor whereas providers need to make sure every piece of the Integration is secure.</p><p>One area that was identified as something we can improve with Openshift and containers in general is when running as root on the container <em>may</em> expose the host and process in that container may be able to mingle with other resources.</p><p>And this is a problem for us at the OpenShift pipelines team since this is what our shipped buildah ClusterTask does by default.</p><p>Ideally we would like to run everything rootless with a randomized user id, like what Openshift does by default. But there are some use-cases needing to run as root on the container but still be secure on the host.</p><p>In this article we will focus on Buildah but some of those techniques can be reused for different workloads, bear in mind that some of those technologies can be pretty bleeding edge, and you may encounter some unexpected side effects, but for the sake of a secure pipeline I would encourage you to try this out and see how it works out for you.</p><h2 id=running-as-root-in-a-user-namespace><strong>Running as root in a user namespace</strong><a hidden class=anchor aria-hidden=true href=#running-as-root-in-a-user-namespace>#</a></h2><p>Running in a user namespace is when you are running the container as root (user id 0) but as user on the host.</p><p>OpenShift is using CRI-O as its container engine. And CRI-O has now a workload feature to be able to let the pod know it wants to run <a href=https://github.com/cri-o/cri-o/blob/main/docs/crio.conf.5.md#crioruntimeworkloads-table>“user namespaced”</a>.</p><p>User namespaces is not a new feature; it has been here for a while, see for example this <a href=https://lwn.net/Articles/532593/>2013 article</a> from the lwn introducing it. But it took some time to be included in RHEL (from RHEL8) and integrated into OpenShift (support was added in Openshift 4.10). If you want to try this feature manually you can refer to <a href=https://www.redhat.com/sysadmin/building-container-namespaces>this article</a> explaining how it works .</p><p>To run as a user in a namespace with Openshift Pipelines you need to be able to pass the annotations expected by CRIO to get the pods running user namespaced.</p><p>You can directly edit the buildah ClusterTask with “oc edit clustertask buildah” to add this to all users, or export the clustertask as a task to a specific Namespace.</p><p>With the latest tkn create from feature you can easily automate it :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>oc new-project <span style=color:#8be9fd;font-style:italic>test</span>
</span></span><span style=display:flex><span>$ tkn task create --from<span style=color:#ff79c6>=</span>buildah
</span></span><span style=display:flex><span>$ oc edit task buildah
</span></span></code></pre></div><p>And add the annotations to the task :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>io.kubernetes.cri-o.userns-mode</span>: <span style=color:#f1fa8c>&#34;auto&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>io.openshift.builder</span>: <span style=color:#f1fa8c>&#34;true&#34;</span>
</span></span></code></pre></div><p>Now if you are running the (currently unreleased) latest Openshift Pipelines 1.7 on OpenShift 4.10, you will see your buildah container running like before as root.</p><p>But if you adventure yourself behind the scene on the host of the pod :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#6272a4># get the nodename where the buildah pod is with &#34;oc get pod -o wide&#34;</span>
</span></span><span style=display:flex><span>$ oc debug nodes/nodename
</span></span><span style=display:flex><span>$ chroot /host
</span></span><span style=display:flex><span>$ lsns -t user
</span></span></code></pre></div><p>OpenShift and CRIO did their magic and ran your pod in a “user namespace”.</p><h2 id=running-as-rootless-in-container><strong>Running as rootless in container</strong><a hidden class=anchor aria-hidden=true href=#running-as-rootless-in-container>#</a></h2><p>To be able to run as rootless inside a container; where you run as a user inside the container, you need your container to do some setup to add the subuid and subgid provided from the latest shadow-utils package.</p><p>Thankfully the public image based on Red Hat UBI has everything already setup for us in its <a href="https://catalog.redhat.com/software/containers/ubi8/buildah/602686f7b16b1eb2e30807ee?container-tabs=dockerfile">Containerfile</a></p><p>You have an extra step to take tho, you need to “force” running the container as
the “build” user, because if we start to leave it to the default it will be
“randomed” and would not have the setup needed to run as non-root.</p><p>Edit directly or export to a specific namespace the buildah clustertask as
described in the previous section. Add this securityContext to each <a href=https://github.com/tektoncd/operator/blob/main/cmd/openshift/operator/kodata/tekton-addon/addons/02-clustertasks/buildah/buildah-task.yaml#L63>build</a>
and <a href=https://github.com/tektoncd/operator/blob/main/cmd/openshift/operator/kodata/tekton-addon/addons/02-clustertasks/buildah/buildah-task.yaml#L75>push</a> steps :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>securityContext: runAsUser: 1000 
</span></span></code></pre></div><p>Since we are now going to be building as user, buildah will keep its image
caching in <strong>/home/build/.local/cache</strong> so instead of volume mounting
<strong>/var/lib/containers</strong> we are going to change the <strong>mountPath</strong> on build and
push steps to the user one :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>volumeMounts</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>name</span>: varlibcontainers
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>mountPath</span>: /home/build/.local/share/containers
</span></span></code></pre></div><p>And for demo purpose I have added this line at the beginning of the script task
:</p><p><code>echo "Running as USER ID id"</code></p><p>I have then created a <a href=https://github.com/tektoncd/pipeline/blob/main/docs/workspaces.md#configmap>ConfigMap workspace</a> with a sample dockerfile and a
sample taskrun to be able to test it.</p><p>When running it, I can see my image is running as user :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>% tkn tr logs -Lf buildah-run
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>build<span style=color:#ff79c6>]</span> ++ id <span style=color:#ff79c6>[</span>build<span style=color:#ff79c6>]</span> Running as USER ID <span style=color:#8be9fd;font-style:italic>uid</span><span style=color:#ff79c6>=</span>1000<span style=color:#ff79c6>(</span>build<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>gid</span><span style=color:#ff79c6>=</span>1000<span style=color:#ff79c6>(</span>build<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>groups</span><span style=color:#ff79c6>=</span>1000<span style=color:#ff79c6>(</span>build<span style=color:#ff79c6>)</span>,1000690000
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>build<span style=color:#ff79c6>]</span> + <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#39;Running as USER ID uid=1000(build) gid=1000(build)
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>groups=1000(build),1000690000&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>build<span style=color:#ff79c6>]</span> + buildah --storage-driver<span style=color:#ff79c6>=</span>vfs bud --format<span style=color:#ff79c6>=</span>oci --tls-verify<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>true</span> --no-cache -f ./Dockerfile -t image-registry.openshift-image-registry.svc:5000/test/buildahuser .
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>build<span style=color:#ff79c6>]</span> STEP 1: FROM registry.access.redhat.com/ubi8/ubi AS buildah-runner
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>build<span style=color:#ff79c6>]</span> Getting image <span style=color:#8be9fd;font-style:italic>source</span> signatures <span style=color:#ff79c6>[</span>build<span style=color:#ff79c6>]</span> Checking <span style=color:#ff79c6>if</span> image destination supports
</span></span><span style=display:flex><span>signatures <span style=color:#ff79c6>[</span>build<span style=color:#ff79c6>]</span> Copying blob
</span></span><span style=display:flex><span>sha256:adffa69631469a649556cee5b8456f184928818064aac82106bd08bd62e51d4e
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>build<span style=color:#ff79c6>]</span> Copying blob sha256:26f1167feaf74177f9054bf26ac8775a4b188f25914e23bda9574ef2a759cce4
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>build<span style=color:#ff79c6>]</span> Copying config sha256:fca12da1dc30ed8e7d03afb84b287fc695673fff9c04bfcb2ff404b558670a36
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>build<span style=color:#ff79c6>]</span> Writing manifest to image destination
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>build<span style=color:#ff79c6>]</span> Storing signatures
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>build<span style=color:#ff79c6>]</span> STEP 2: RUN dnf -y update <span style=color:#ff79c6>&amp;&amp;</span> dnf -y install git <span style=color:#ff79c6>&amp;&amp;</span> dnf clean all
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>build<span style=color:#ff79c6>]</span> Updating Subscription Management repositories.  <span style=color:#ff79c6>[</span>…<span style=color:#ff79c6>]</span>
</span></span></code></pre></div><h2 id=more-security-with-a-custom-scc>More security with a custom SCC<a hidden class=anchor aria-hidden=true href=#more-security-with-a-custom-scc>#</a></h2><p>Now these steps are working because currently on Openshift Pipelines we make all
taskrun/pipelinerun running automatically as the pipelines serviceAccount which
has the pipelines SecurityContext that allows running as any user.</p><p>We have added those rights to have it easy to to migrate pipelines that needs to
be run or build as root, but if you like to further lock down your installation
you can only allow running container as the user 1000 if the pod is asking (or
the container image forces it) for it and don’t let the container running as
root by default.</p><p>To do so you need to edit the pipelines-scc and modify the runAsUser and
seLinuxContext section to MustRunAs to uid 1000 :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>runAsUser</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>type</span>: MustRunAs
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>uid</span>: <span style=color:#bd93f9>1000</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>seLinuxContext</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>type</span>: MustRunAs
</span></span></code></pre></div><p>The pipeline serviceaccount will only allow running images as user 1000 and not
as root anymore, if the images are not running as 1000 they will berandomed out as user id.</p><h2 id=templates-examples>Templates examples<a hidden class=anchor aria-hidden=true href=#templates-examples>#</a></h2><p>This gist reference all the files I am mentioned int his article</p><ul><li><p>Buildah.yaml force running as user build : <a href=https://gist.github.com/chmouel/8242806100ffa7164bb63d7d5b0a593d#file-buildah-task-yaml>https://gist.github.com/chmouel/8242806100ffa7164bb63d7d5b0a593d#file-buildah-task-yaml</a></p></li><li><p>Taskrun and Dockerfile configmap workspace: <a href=https://gist.github.com/chmouel/8242806100ffa7164bb63d7d5b0a593d#file-buildah-taskrun-configmap-yaml>https://gist.github.com/chmouel/8242806100ffa7164bb63d7d5b0a593d#file-buildah-taskrun-configmap-yaml</a></p></li><li><p>Modified scc only allow running as user 1000: <a href=https://gist.github.com/chmouel/8242806100ffa7164bb63d7d5b0a593d#file-scc-runasuser-drop-anyuid-yaml>https://gist.github.com/chmouel/8242806100ffa7164bb63d7d5b0a593d#file-scc-runasuser-drop-anyuid-yaml</a></p></li></ul></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://blog.chmouel.com/>Chmouel's blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>