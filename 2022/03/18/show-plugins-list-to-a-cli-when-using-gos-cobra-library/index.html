<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Show plugins list to a CLI when using go’s cobra library | Chmouel's blog</title><meta name=keywords content><meta name=description content="With the TektonCD CLI we have a system of &ldquo;plugins&rdquo;, it&rsquo;s the same very simple CLI plugin system you have with git or kubectl, if you do a :
kubectl blah foo --bar
since kubectl knows it doesn&rsquo;t have the blah command will try to go over the filesystem paths in your $PATH environment and sees if there is a binary called kubectl-blah and if it finds it will pass the arguments to the binary which effectively become :"><meta name=author content><link rel=canonical href=https://blog.chmouel.com/2022/03/18/show-plugins-list-to-a-cli-when-using-gos-cobra-library/><link crossorigin=anonymous href=/assets/css/stylesheet.min.286ffbab1cfdcf5c35ec0edbfc67759192b408de6939c558bbd4a964ca89f552.css integrity="sha256-KG/7qxz9z1w17A7b/Gd1kZK0CN5pOcVYu9SpZMqJ9VI=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.chmouel.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.chmouel.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.chmouel.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.chmouel.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.chmouel.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Show plugins list to a CLI when using go’s cobra library"><meta property="og:description" content="With the TektonCD CLI we have a system of &ldquo;plugins&rdquo;, it&rsquo;s the same very simple CLI plugin system you have with git or kubectl, if you do a :
kubectl blah foo --bar
since kubectl knows it doesn&rsquo;t have the blah command will try to go over the filesystem paths in your $PATH environment and sees if there is a binary called kubectl-blah and if it finds it will pass the arguments to the binary which effectively become :"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.chmouel.com/2022/03/18/show-plugins-list-to-a-cli-when-using-gos-cobra-library/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-18T08:53:02+00:00"><meta property="article:modified_time" content="2022-03-18T08:53:02+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Show plugins list to a CLI when using go’s cobra library"><meta name=twitter:description content="With the TektonCD CLI we have a system of &ldquo;plugins&rdquo;, it&rsquo;s the same very simple CLI plugin system you have with git or kubectl, if you do a :
kubectl blah foo --bar
since kubectl knows it doesn&rsquo;t have the blah command will try to go over the filesystem paths in your $PATH environment and sees if there is a binary called kubectl-blah and if it finds it will pass the arguments to the binary which effectively become :"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.chmouel.com/posts/"},{"@type":"ListItem","position":2,"name":"Show plugins list to a CLI when using go’s cobra library","item":"https://blog.chmouel.com/2022/03/18/show-plugins-list-to-a-cli-when-using-gos-cobra-library/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Show plugins list to a CLI when using go’s cobra library","name":"Show plugins list to a CLI when using go’s cobra library","description":"With the TektonCD CLI we have a system of \u0026ldquo;plugins\u0026rdquo;, it\u0026rsquo;s the same very simple CLI plugin system you have with git or kubectl, if you do a :\nkubectl blah foo --bar\nsince kubectl knows it doesn\u0026rsquo;t have the blah command will try to go over the filesystem paths in your $PATH environment and sees if there is a binary called kubectl-blah and if it finds it will pass the arguments to the binary which effectively become :","keywords":[],"articleBody":"With the TektonCD CLI we have a system of “plugins”, it’s the same very simple CLI plugin system you have with git or kubectl, if you do a :\nkubectl blah foo --bar\nsince kubectl knows it doesn’t have the blah command will try to go over the filesystem paths in your $PATH environment and sees if there is a binary called kubectl-blah and if it finds it will pass the arguments to the binary which effectively become :\nkubectl-blah foo --bar\nall very transparent and easy to install and use.\nThe problem with this is that the user doesn’t really knows about it and discovery is limited unless the user knows about the command already.\nkubectl added a plugin list argument to list easily all plugins available (or in kubectl case you can just use krew to manage kubectl plugins).\nFor tektoncd-cli we wanted to shows it directly in the Root commands help. So when the user type tkn help it will shows the plugin list.\nSince tektoncd-cli is using the spf13/cobra library, and the lib being very extensible, it wasn’t hard to extend the help system.\nYou first need to define a custom “usage template”, the template we have is this one :\nhttps://github.com/chmouel/tektoncd-cli/blob/add-available-plugins-from-path/pkg/cmd/root.go#L46\nIt adds this snippet to the default template :\n{{if gt (len pluginList) 0}} Available Plugins: {{- range pluginList}}  {{.}}{{end}}{{end}}{{if .HasAvailableLocalFlags}} The pluginList template variable is a slice of plugins which is discovered in this function :\nfunc addPluginsToHelp() { \tpluginlist := []string{} \tpaths := strings.Split(os.Getenv(\"PATH\"), \":\") \t// go over all paths in the PATH environment \t// and add them to the completion command \tfor _, path := range paths { \t// list all files in path \tfiles, err := ioutil.ReadDir(path) \tif err != nil { \tcontinue \t} \t// add all files that start with tkn- \tfor _, file := range files { \tif strings.HasPrefix(file.Name(), \"tkn-\") { \tbasep := strings.ReplaceAll(file.Name(), \"tkn-\", \"\") \tfpath := filepath.Join(path, file.Name()) \tinfo, err := os.Stat(fpath) \tif err != nil { \tcontinue \t} \tif info.Mode()\u00260o111 != 0 { \tpluginlist = append(pluginlist, basep) \t} \t} \t} \t} \tcobra.AddTemplateFunc(\"pluginList\", func() []string { return pluginlist }) } what it does is, go over the environement variable PATH gets all directories from there, check all executable binaries that starts with the “tkn-” prefix and add it to the template variable pluginList inside a slice of strings.\nThe plugin command will show then nicely when doing tkn help. for example with the Pipelines as Code CLI installed, I will get this :\n$ tkn help CLI for tekton pipelines Usage: tkn [flags] tkn [command] Available Commands: bundle Manage Tekton Bundles chain Manage Chains clustertask Manage ClusterTasks condition Manage Conditions eventlistener Manage EventListeners hub Interact with tekton hub pipeline Manage pipelines pipelinerun Manage PipelineRuns resource Manage pipeline resources task Manage Tasks taskrun Manage TaskRuns triggerbinding Manage TriggerBindings triggertemplate Manage TriggerTemplates Other Commands: completion Prints shell completion scripts version Prints version information Available Plugins: pac Flags: -h, --help help for tkn Use \"tkn [command] --help\" for more information about a command.  There is maybe area for improvement to be able to get a small snippet of what the plugin is actually doing in the future but so far having it in the root help is a great boost for CLI discoverability.\nThe full PR on tektoncd cli is here if you wanted to look at the full code and tests :\nhttps://github.com/tektoncd/cli/pull/1535\n","wordCount":"565","inLanguage":"en","datePublished":"2022-03-18T08:53:02Z","dateModified":"2022-03-18T08:53:02Z","author":{"@type":"Person","name":"chmouel"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.chmouel.com/2022/03/18/show-plugins-list-to-a-cli-when-using-gos-cobra-library/"},"publisher":{"@type":"Organization","name":"Chmouel's blog","logo":{"@type":"ImageObject","url":"https://blog.chmouel.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.chmouel.com/ accesskey=h title="Chmouel's blog (Alt + H)">Chmouel's blog</a>
<span class=logo-switches></span></div><ul id=menu><li><a href=https://github.com/chmouel/ title=Github><span>Github</span></a></li><li><a href=https://photos.chmouel.com title=Photos><span>Photos</span></a></li><li><a href=https://app.strava.com/athletes/126695 title=Strava><span>Strava</span></a></li><li><a href=https://twitter.com/chmouel title=Twitter><span>Twitter</span></a></li><li><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Show plugins list to a CLI when using go’s cobra library</h1><div class=post-meta><span title="2022-03-18 08:53:02 +0000 UTC">March 18, 2022</span>&nbsp;|&nbsp;<a href=https://github.com/chmouel/blog/tree/main/content/posts/2022-03-18-show-plugins-list-to-a-cli-when-using-gos-cobra-library.md rel="noopener noreferrer" target=_blank>Edit</a></div></header><div class=post-content><p>With the TektonCD CLI we have a system of &ldquo;plugins&rdquo;, it&rsquo;s the same very simple CLI plugin system you have with git or kubectl, if you do a :</p><p><code>kubectl blah foo --bar</code></p><p>since kubectl knows it doesn&rsquo;t have the blah command will try to go over the
filesystem paths in your <code>$PATH</code> environment and sees if there is a binary
called <code>kubectl-blah</code> and if it finds it will pass the arguments to the binary
which effectively become :</p><p><code>kubectl-blah foo --bar</code></p><p>all very transparent and easy to install and use.</p><p>The problem with this is that the user doesn&rsquo;t really knows about it and discovery is limited unless the user knows about the command already.</p><p>kubectl added a <a href=https://kubernetes.io/docs/tasks/extend-kubectl/kubectl-plugins/#discovering-plugins><code>plugin list</code></a> argument to list easily all plugins available (or in kubectl case you can just use <a href=https://krew.dev>krew</a> to manage kubectl plugins).</p><p>For <a href=https://github.com/tektoncd/cli/><code>tektoncd-cli</code></a> we wanted to shows it directly in the <code>Root</code> commands help. So when the user type <code>tkn help</code> it will shows the plugin list.</p><p>Since <code>tektoncd-cli</code> is using the <a href=https://github.com/spf13/cobra><code>spf13/cobra</code></a> library, and the lib being very extensible, it wasn&rsquo;t hard to extend the help system.</p><p>You first need to define a custom &ldquo;usage template&rdquo;, the template we have is this one :</p><p><a href=https://github.com/chmouel/tektoncd-cli/blob/add-available-plugins-from-path/pkg/cmd/root.go#L46>https://github.com/chmouel/tektoncd-cli/blob/add-available-plugins-from-path/pkg/cmd/root.go#L46</a></p><p>It adds this snippet to the default template :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span>{{<span style=color:#ff79c6>if</span> <span style=color:#50fa7b>gt</span> (len pluginList) <span style=color:#bd93f9>0</span>}}
</span></span><span style=display:flex><span>Available Plugins:
</span></span><span style=display:flex><span>{{<span style=color:#ff79c6>-</span> <span style=color:#ff79c6>range</span> pluginList}}
</span></span><span style=display:flex><span>  {{.}}{{end}}{{end}}{{<span style=color:#ff79c6>if</span> .HasAvailableLocalFlags}}
</span></span></code></pre></div><p>The <code>pluginList</code> template variable is a slice of plugins which is discovered in this function :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>addPluginsToHelp</span>() {
</span></span><span style=display:flex><span>	pluginlist <span style=color:#ff79c6>:=</span> []<span style=color:#8be9fd>string</span>{}
</span></span><span style=display:flex><span>	paths <span style=color:#ff79c6>:=</span> strings.<span style=color:#50fa7b>Split</span>(os.<span style=color:#50fa7b>Getenv</span>(<span style=color:#f1fa8c>&#34;PATH&#34;</span>), <span style=color:#f1fa8c>&#34;:&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// go over all paths in the PATH environment
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#6272a4>// and add them to the completion command
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#ff79c6>for</span> _, path <span style=color:#ff79c6>:=</span> <span style=color:#ff79c6>range</span> paths {
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// list all files in path
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>		files, err <span style=color:#ff79c6>:=</span> ioutil.<span style=color:#50fa7b>ReadDir</span>(path)
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// add all files that start with tkn-
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>		<span style=color:#ff79c6>for</span> _, file <span style=color:#ff79c6>:=</span> <span style=color:#ff79c6>range</span> files {
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>if</span> strings.<span style=color:#50fa7b>HasPrefix</span>(file.<span style=color:#50fa7b>Name</span>(), <span style=color:#f1fa8c>&#34;tkn-&#34;</span>) {
</span></span><span style=display:flex><span>				basep <span style=color:#ff79c6>:=</span> strings.<span style=color:#50fa7b>ReplaceAll</span>(file.<span style=color:#50fa7b>Name</span>(), <span style=color:#f1fa8c>&#34;tkn-&#34;</span>, <span style=color:#f1fa8c>&#34;&#34;</span>)
</span></span><span style=display:flex><span>				fpath <span style=color:#ff79c6>:=</span> filepath.<span style=color:#50fa7b>Join</span>(path, file.<span style=color:#50fa7b>Name</span>())
</span></span><span style=display:flex><span>				info, err <span style=color:#ff79c6>:=</span> os.<span style=color:#50fa7b>Stat</span>(fpath)
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span>					<span style=color:#ff79c6>continue</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>if</span> info.<span style=color:#50fa7b>Mode</span>()<span style=color:#ff79c6>&amp;</span><span style=color:#bd93f9>0</span>o111 <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span> {
</span></span><span style=display:flex><span>					pluginlist = <span style=color:#8be9fd;font-style:italic>append</span>(pluginlist, basep)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	cobra.<span style=color:#50fa7b>AddTemplateFunc</span>(<span style=color:#f1fa8c>&#34;pluginList&#34;</span>, <span style=color:#8be9fd;font-style:italic>func</span>() []<span style=color:#8be9fd>string</span> { <span style=color:#ff79c6>return</span> pluginlist })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>what it does is, go over the environement variable PATH gets all directories from there, check all executable binaries that starts with the &ldquo;tkn-&rdquo; prefix and add it to the template variable pluginList inside a slice of strings.</p><p>The plugin command will show then nicely when doing <code>tkn help</code>. for example with the <a href=github.com/openshift-pipelines/pipelines-as-code/><code>Pipelines as Code</code></a> CLI installed, I will get this :</p><pre><code>$ tkn help
CLI for tekton pipelines

Usage:
tkn [flags]
tkn [command]

Available Commands:
  bundle                    Manage Tekton Bundles
  chain                      Manage Chains
  clustertask              Manage ClusterTasks
  condition                Manage Conditions
  eventlistener          Manage EventListeners
  hub                        Interact with tekton hub
  pipeline                  Manage pipelines
  pipelinerun             Manage PipelineRuns
  resource                 Manage pipeline resources
  task                        Manage Tasks
  taskrun                   Manage TaskRuns
  triggerbinding         Manage TriggerBindings
  triggertemplate       Manage TriggerTemplates

Other Commands:
  completion         Prints shell completion scripts
  version               Prints version information

Available Plugins:
  pac

Flags:
  -h, --help   help for tkn

Use &quot;tkn [command] --help&quot; for more information about a command.
</code></pre><p>There is maybe area for improvement to be able to get a small snippet of what the plugin is actually doing in the future but so far having it in the root help is a great boost for CLI discoverability.</p><p>The full PR on tektoncd cli is here if you wanted to look at the full code and tests :</p><p><a href=https://github.com/tektoncd/cli/pull/1535>https://github.com/tektoncd/cli/pull/1535</a></p></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://blog.chmouel.com/>Chmouel's blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>