<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Show plugins list to a CLI when using go’s cobra library | Chmouel's blog</title><link rel=stylesheet href=https://blog.chmouel.com/assets/css/post.css><script defer src=https://blog.chmouel.com/assets/js/lbox.js></script>
<link rel=stylesheet href=https://blog.chmouel.com/assets/css/common.css></head><body><main><section id=bio><section id=img-wrapper><a class=site-title href=https://blog.chmouel.com/><img src=/static/chmouel.png alt></a></section><section id=bio-wrapper><div id=text-wrapper><div class=centered><a href=/>Home</a>&nbsp; <a href=https://photos.chmouel.com>Photos</a>&nbsp; <a href=https://twitter.com/chmouel target=_blank>Twitter</a>&nbsp; <a href=https://github.com/chmouel target=_blank>Github</a>&nbsp; <a href=https://app.strava.com/athletes/126695 target=_blank>Strava</a>&nbsp; <a href=https://redhat.com target=_blank>Work</a></div><br><p>Chmouel Boudjnah's OpenSource developer Blog</p></div><div id=social-wrapper></div></section></section><br><section class=article><div class=article-header><h2 class=article-title>Show plugins list to a CLI when using go’s cobra library</h2><div class=date>Fri Mar 18, 2022</div><div class=tags></div></div><div class=content><p>With the TektonCD CLI we have a system of &ldquo;plugins&rdquo;, it&rsquo;s the same very simple CLI plugin system you have with git or kubectl, if you do a :</p><p><code>kubectl blah foo --bar</code></p><p>since kubectl knows it doesn&rsquo;t have the blah command will try to go over the
filesystem paths in your <code>$PATH</code> environment and sees if there is a binary
called <code>kubectl-blah</code> and if it finds it will pass the arguments to the binary
which effectively become :</p><p><code>kubectl-blah foo --bar</code></p><p>all very transparent and easy to install and use.</p><p>The problem with this is that the user doesn&rsquo;t really knows about it and discovery is limited unless the user knows about the command already.</p><p>kubectl added a <a href=https://kubernetes.io/docs/tasks/extend-kubectl/kubectl-plugins/#discovering-plugins><code>plugin list</code></a> argument to list easily all plugins available (or in kubectl case you can just use <a href=https://krew.dev>krew</a> to manage kubectl plugins).</p><p>For <a href=https://github.com/tektoncd/cli/><code>tektoncd-cli</code></a> we wanted to shows it directly in the <code>Root</code> commands help. So when the user type <code>tkn help</code> it will shows the plugin list.</p><p>Since <code>tektoncd-cli</code> is using the <a href=https://github.com/spf13/cobra><code>spf13/cobra</code></a> library, and the lib being very extensible, it wasn&rsquo;t hard to extend the help system.</p><p>You first need to define a custom &ldquo;usage template&rdquo;, the template we have is this one :</p><p><a href=https://github.com/chmouel/tektoncd-cli/blob/add-available-plugins-from-path/pkg/cmd/root.go#L46>https://github.com/chmouel/tektoncd-cli/blob/add-available-plugins-from-path/pkg/cmd/root.go#L46</a></p><p>It adds this snippet to the default template :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span>{{<span style=color:#ff79c6>if</span> <span style=color:#50fa7b>gt</span> (len pluginList) <span style=color:#bd93f9>0</span>}}
</span></span><span style=display:flex><span>Available Plugins:
</span></span><span style=display:flex><span>{{<span style=color:#ff79c6>-</span> <span style=color:#ff79c6>range</span> pluginList}}
</span></span><span style=display:flex><span>  {{.}}{{end}}{{end}}{{<span style=color:#ff79c6>if</span> .HasAvailableLocalFlags}}
</span></span></code></pre></div><p>The <code>pluginList</code> template variable is a slice of plugins which is discovered in this function :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>addPluginsToHelp</span>() {
</span></span><span style=display:flex><span>	pluginlist <span style=color:#ff79c6>:=</span> []<span style=color:#8be9fd>string</span>{}
</span></span><span style=display:flex><span>	paths <span style=color:#ff79c6>:=</span> strings.<span style=color:#50fa7b>Split</span>(os.<span style=color:#50fa7b>Getenv</span>(<span style=color:#f1fa8c>&#34;PATH&#34;</span>), <span style=color:#f1fa8c>&#34;:&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// go over all paths in the PATH environment
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#6272a4>// and add them to the completion command
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#ff79c6>for</span> _, path <span style=color:#ff79c6>:=</span> <span style=color:#ff79c6>range</span> paths {
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// list all files in path
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>		files, err <span style=color:#ff79c6>:=</span> ioutil.<span style=color:#50fa7b>ReadDir</span>(path)
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// add all files that start with tkn-
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>		<span style=color:#ff79c6>for</span> _, file <span style=color:#ff79c6>:=</span> <span style=color:#ff79c6>range</span> files {
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>if</span> strings.<span style=color:#50fa7b>HasPrefix</span>(file.<span style=color:#50fa7b>Name</span>(), <span style=color:#f1fa8c>&#34;tkn-&#34;</span>) {
</span></span><span style=display:flex><span>				basep <span style=color:#ff79c6>:=</span> strings.<span style=color:#50fa7b>ReplaceAll</span>(file.<span style=color:#50fa7b>Name</span>(), <span style=color:#f1fa8c>&#34;tkn-&#34;</span>, <span style=color:#f1fa8c>&#34;&#34;</span>)
</span></span><span style=display:flex><span>				fpath <span style=color:#ff79c6>:=</span> filepath.<span style=color:#50fa7b>Join</span>(path, file.<span style=color:#50fa7b>Name</span>())
</span></span><span style=display:flex><span>				info, err <span style=color:#ff79c6>:=</span> os.<span style=color:#50fa7b>Stat</span>(fpath)
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span>					<span style=color:#ff79c6>continue</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>if</span> info.<span style=color:#50fa7b>Mode</span>()<span style=color:#ff79c6>&amp;</span><span style=color:#bd93f9>0</span>o111 <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span> {
</span></span><span style=display:flex><span>					pluginlist = <span style=color:#8be9fd;font-style:italic>append</span>(pluginlist, basep)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	cobra.<span style=color:#50fa7b>AddTemplateFunc</span>(<span style=color:#f1fa8c>&#34;pluginList&#34;</span>, <span style=color:#8be9fd;font-style:italic>func</span>() []<span style=color:#8be9fd>string</span> { <span style=color:#ff79c6>return</span> pluginlist })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>what it does is, go over the environement variable PATH gets all directories from there, check all executable binaries that starts with the &ldquo;tkn-&rdquo; prefix and add it to the template variable pluginList inside a slice of strings.</p><p>The plugin command will show then nicely when doing <code>tkn help</code>. for example with the <a href=github.com/openshift-pipelines/pipelines-as-code/><code>Pipelines as Code</code></a> CLI installed, I will get this :</p><pre><code>$ tkn help
CLI for tekton pipelines

Usage:
tkn [flags]
tkn [command]

Available Commands:
  bundle                    Manage Tekton Bundles
  chain                      Manage Chains
  clustertask              Manage ClusterTasks
  condition                Manage Conditions
  eventlistener          Manage EventListeners
  hub                        Interact with tekton hub
  pipeline                  Manage pipelines
  pipelinerun             Manage PipelineRuns
  resource                 Manage pipeline resources
  task                        Manage Tasks
  taskrun                   Manage TaskRuns
  triggerbinding         Manage TriggerBindings
  triggertemplate       Manage TriggerTemplates

Other Commands:
  completion         Prints shell completion scripts
  version               Prints version information

Available Plugins:
  pac

Flags:
  -h, --help   help for tkn

Use &quot;tkn [command] --help&quot; for more information about a command.
</code></pre><p>There is maybe area for improvement to be able to get a small snippet of what the plugin is actually doing in the future but so far having it in the root help is a great boost for CLI discoverability.</p><p>The full PR on tektoncd cli is here if you wanted to look at the full code and tests :</p><p><a href=https://github.com/tektoncd/cli/pull/1535>https://github.com/tektoncd/cli/pull/1535</a></p></div></section><footer class=footer><p><a href=https://github.com/chmouel/blog>&copy;</a> Chmouel Boudjnah - <a href=https://photos.chmouel.com><span class=fontawesome-inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M194.6 32H317.4c20.7.0 39 13.22 45.5 32.82L373.3 96H448c35.3.0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.35.0-64-28.7-64-64V160c0-35.3 28.65-64 64-64h74.7l10.4-31.18C155.6 45.22 173.9 32 194.6 32h0zM256 384c53 0 96-43 96-96 0-53.9-43-96-96-96-53.9.0-96 42.1-96 96 0 53 42.1 96 96 96z"/></svg></span></a>&nbsp;<a href=https://twitter.com/chmouel><span class=fontawesome-inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></span>
</a><a href=https://github.com/chmouel><span class=fontawesome-inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a></p></footer></main></body></html>