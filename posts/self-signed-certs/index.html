<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Trusting self signed certs with Ingress Controller on Kubernetes | Chmouel's blog</title>
<meta name=keywords content><meta name=description content="I have a very complicated development environment, which spins up a local Kubernetes cluster on Kind and then deploys a bunch of services to it.
Some of the services gets accessed by the browser and until late I was deploying everything on localhost which so far did not cause any issues, since the browser are good at trusting localhost.
But since my laptop was getting slower and slower and I had a new raspberry pi 5 unused with a SSD, I decided to made it my local Kubernetes cluster."><meta name=author content><link rel=canonical href=https://blog.chmouel.com/posts/self-signed-certs/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://blog.chmouel.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.chmouel.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.chmouel.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.chmouel.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.chmouel.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Trusting self signed certs with Ingress Controller on Kubernetes"><meta property="og:description" content="I have a very complicated development environment, which spins up a local Kubernetes cluster on Kind and then deploys a bunch of services to it.
Some of the services gets accessed by the browser and until late I was deploying everything on localhost which so far did not cause any issues, since the browser are good at trusting localhost.
But since my laptop was getting slower and slower and I had a new raspberry pi 5 unused with a SSD, I decided to made it my local Kubernetes cluster."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.chmouel.com/posts/self-signed-certs/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-26T15:11:55+01:00"><meta property="article:modified_time" content="2024-01-26T15:11:55+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Trusting self signed certs with Ingress Controller on Kubernetes"><meta name=twitter:description content="I have a very complicated development environment, which spins up a local Kubernetes cluster on Kind and then deploys a bunch of services to it.
Some of the services gets accessed by the browser and until late I was deploying everything on localhost which so far did not cause any issues, since the browser are good at trusting localhost.
But since my laptop was getting slower and slower and I had a new raspberry pi 5 unused with a SSD, I decided to made it my local Kubernetes cluster."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.chmouel.com/posts/"},{"@type":"ListItem","position":2,"name":"Trusting self signed certs with Ingress Controller on Kubernetes","item":"https://blog.chmouel.com/posts/self-signed-certs/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Trusting self signed certs with Ingress Controller on Kubernetes","name":"Trusting self signed certs with Ingress Controller on Kubernetes","description":"I have a very complicated development environment, which spins up a local Kubernetes cluster on Kind and then deploys a bunch of services to it.\nSome of the services gets accessed by the browser and until late I was deploying everything on localhost which so far did not cause any issues, since the browser are good at trusting localhost.\nBut since my laptop was getting slower and slower and I had a new raspberry pi 5 unused with a SSD, I decided to made it my local Kubernetes cluster.","keywords":[],"articleBody":"I have a very complicated development environment, which spins up a local Kubernetes cluster on Kind and then deploys a bunch of services to it.\nSome of the services gets accessed by the browser and until late I was deploying everything on localhost which so far did not cause any issues, since the browser are good at trusting localhost.\nBut since my laptop was getting slower and slower and I had a new raspberry pi 5 unused with a SSD, I decided to made it my local Kubernetes cluster.\nDeploying Kubernetes on a Raspberry Pi 5 running the raspbian distribution with nix is probably a post on its own, but let’s assume it’s already deployed. Now I have a new issue, since we are not running on localhost the browser don’t trust it anymore and everytime I redeploy I need to click again on those pesky “Trust me bro, I know what I’m doing” (or something along those lines) scary box.\nI spent a bit of time reading this LetsEncrypt blog post https://letsencrypt.org/docs/certificates-for-localhost/ which had a link to this fantastic tool called minica. It’s pretty straightforward it create a CA root and then create domains out of it.\nIn your browsers you only trust the CA root and everytime you generate domains, they are being trusted.\nGenerating a certificate and deploying an Ingress To plug this with ingress-nginx I do something like this:\nFirst generate a domain for $domain with minica: mkdir -p minica;cd minica/ minica -domains $domain (if it is already generated then the minica command will fail then make sure it’s not)\nYou will hen create a Kubernetes secret out of it which we will call $sec_name on namespace $namespace using the generate secret from minica. key_file=minica/${domain}/key.pem cert_file=minica/${domain}/cert.pem kubectl create secret tls ${sec_name} --key ${key_file} --cert ${cert_file} -n ${namespace} And then we create a Ingress out of it for a component on targetPort expose as ${host} (for example for a docker registry, I use docker-registry as component, 5000 as targetPort and host as registry.local which resolve via my local DNS but you can use a /etc/host entry too) cat \u003c","wordCount":"722","inLanguage":"en","datePublished":"2024-01-26T15:11:55+01:00","dateModified":"2024-01-26T15:11:55+01:00","author":{"@type":"Person","name":"Chmouel Boudjnah"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.chmouel.com/posts/self-signed-certs/"},"publisher":{"@type":"Organization","name":"Chmouel's blog","logo":{"@type":"ImageObject","url":"https://blog.chmouel.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.chmouel.com/ accesskey=h title="Chmouel's blog (Alt + H)">Chmouel's blog</a>
<span class=logo-switches></span></div><ul id=menu><li><a href=https://photos.chmouel.com title=camera><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><title>Photo Website</title><path d="M149.1 64.8 138.7 96H64C28.7 96 0 124.7.0 160V416c0 35.3 28.7 64 64 64H448c35.3.0 64-28.7 64-64V160c0-35.3-28.7-64-64-64H373.3L362.9 64.8C356.4 45.2 338.1 32 317.4 32H194.6c-20.7.0-39 13.2-45.5 32.8zM256 192a96 96 0 110 192 96 96 0 110-192z"/></svg>
<span></span></a></li><li><a href=https://github.com/chmouel/ title=GitHub><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
<span></span></a></li><li><a href=https://fosstodon.org/@chmouel title=Mastodon><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>
<span></span></a></li><li><a href=https://redhat.com title=redhat><svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" id="b6bdd2b4-52ab-488a-9a30-1e6d1d7dd2d4" data-name="Layer 1" viewBox="0 0 192.30001 146" sodipodi:docname="logo.svg" width="192.3" height="146" inkscape:version="0.92.5 (2060ec1f9f, 2020-04-08)"><sodipodi:namedview bordercolor="#666666" borderopacity="1" objecttolerance="10" gridtolerance="10" guidetolerance="10" inkscape:pageopacity="0" inkscape:pageshadow="2" inkscape:window-width="1920" inkscape:window-height="1007" id="namedview13" showgrid="false" fit-margin-top="1" fit-margin-right="1" fit-margin-bottom="1" fit-margin-left="1" inkscape:zoom=".45930043" inkscape:cx="306.89999" inkscape:cy="73" inkscape:window-x="0" inkscape:window-y="0" inkscape:window-maximized="1" inkscape:current-layer="b6bdd2b4-52ab-488a-9a30-1e6d1d7dd2d4"/><title>Red Hat</title><path class="a737459c-e8c7-4afa-8008-f6cfd15ccda2" d="m128 84c12.5.0 30.6-2.6 30.6-17.5a19.53 19.53.0 00-.3-3.4L150.9 30.7C149.2 23.6 147.7 20.3 135.2 14.1 125.5 9.1 104.4 1 98.1 1 92.2 1 90.5 8.5 83.6 8.5 76.9 8.5 72 2.9 65.7 2.9c-6 0-9.9 4.1-12.9 12.5.0.0-8.4 23.7-9.5 27.2a6.15 6.15.0 00-.2 1.9C43 53.7 79.3 83.9 128 84m32.5-11.4c1.7 8.2 1.7 9.1 1.7 10.1.0 14-15.7 21.8-36.4 21.8C79 104.5 38.1 77.1 38.1 59a18.35 18.35.0 011.5-7.3C22.8 52.5 1 55.5 1 74.7 1 106.2 75.6 145 134.6 145c45.3.0 56.7-20.5 56.7-36.7.0-12.7-11-27.1-30.8-35.7" id="path8" inkscape:connector-curvature="0"/><path d="m160.5 72.6c1.7 8.2 1.7 9.1 1.7 10.1.0 14-15.7 21.8-36.4 21.8C79 104.5 38.1 77.1 38.1 59a18.35 18.35.0 011.5-7.3l3.7-9.1a6.15 6.15.0 00-.2 1.9c0 9.2 36.3 39.4 84.9 39.4 12.5.0 30.6-2.6 30.6-17.5A19.53 19.53.0 00158.3 63z" id="path10" inkscape:connector-curvature="0"/></svg>
<span></span></a></li><li><a href=https://app.strava.com/athletes/126695 title=Strava><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M158.4.0 7 292h89.2l62.2-116.1L220.1 292h88.5zm150.2 292-43.9 88.2-44.6-88.2h-67.6l112.2 220 111.5-220z"/></svg>
<span></span></a></li><li><a href=https://twitter.com/chmouel title=Twitter><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
<span></span></a></li><li><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Trusting self signed certs with Ingress Controller on Kubernetes</h1><div class=post-meta><span title='2024-01-26 15:11:55 +0100 +0100'>January 26, 2024</span>&nbsp;|&nbsp;<a href=https://github.com/chmouel/blog/tree/main/content/posts/self-signed-certs.md rel="noopener noreferrer" target=_blank>Edit</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#generating-a-certificate-and-deploying-an-ingress aria-label="Generating a certificate and deploying an Ingress">Generating a certificate and deploying an Ingress</a></li><li><a href=#clients aria-label=Clients>Clients</a><ul><li><a href=#installing-the-certificate-system-wise-linux aria-label="Installing the certificate system wise (Linux)">Installing the certificate system wise (Linux)</a></li><li><a href=#linux-generic aria-label="Linux (generic)">Linux (generic)</a></li><li><a href=#nixos aria-label=NixOS>NixOS</a></li><li><a href=#curl aria-label=Curl>Curl</a></li><li><a href=#firefox aria-label=Firefox>Firefox</a></li><li><a href=#chrome-browsers aria-label="Chrome browsers">Chrome browsers</a></li><li><a href=#python-request aria-label="Python request">Python request</a></li></ul></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li></ul></div></details></div><div class=post-content><p>I have a very complicated development environment, which spins up a local
Kubernetes cluster on Kind and then deploys a bunch of services to it.</p><p>Some of the services gets accessed by the browser and until late I was deploying
everything on localhost which so far did not cause any issues, since the browser
are good at trusting localhost.</p><p>But since my laptop was getting slower and slower and I had a new raspberry pi 5
unused with a SSD, I decided to made it my local Kubernetes cluster.</p><p>Deploying Kubernetes on a Raspberry Pi 5 running the raspbian distribution with
nix is probably a post on its own, but let&rsquo;s assume it&rsquo;s already deployed. Now
I have a new issue, since we are not running on localhost the browser don&rsquo;t
trust it anymore and everytime I redeploy I need to click again on those pesky
&ldquo;Trust me bro, I know what I&rsquo;m doing&rdquo; (or something along those lines) scary
box.</p><p>I spent a bit of time reading this LetsEncrypt blog post
<a href=https://letsencrypt.org/docs/certificates-for-localhost/>https://letsencrypt.org/docs/certificates-for-localhost/</a> which had a link to
this fantastic tool called <a href=https://github.com/jsha/minica/>minica</a>. It&rsquo;s
pretty straightforward it create a CA root and then create domains out of it.</p><p>In your browsers you only trust the CA root and everytime you generate domains,
they are being trusted.</p><h2 id=generating-a-certificate-and-deploying-an-ingress>Generating a certificate and deploying an Ingress<a hidden class=anchor aria-hidden=true href=#generating-a-certificate-and-deploying-an-ingress>#</a></h2><p>To plug this with ingress-nginx I do something like this:</p><ol><li>First generate a domain for <code>$domain</code> with minica:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p minica;<span style=color:#8be9fd;font-style:italic>cd</span> minica/
</span></span><span style=display:flex><span>minica -domains <span style=color:#8be9fd;font-style:italic>$domain</span>
</span></span></code></pre></div><p>(if it is already generated then the <code>minica</code> command will fail then make sure it&rsquo;s not)</p><ol start=2><li>You will hen create a Kubernetes secret out of it which we will call <code>$sec_name</code> on
namespace <code>$namespace</code> using the generate secret from <code>minica.</code></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>key_file</span><span style=color:#ff79c6>=</span>minica/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>domain</span><span style=color:#f1fa8c>}</span>/key.pem
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>cert_file</span><span style=color:#ff79c6>=</span>minica/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>domain</span><span style=color:#f1fa8c>}</span>/cert.pem
</span></span><span style=display:flex><span>kubectl create secret tls <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>sec_name</span><span style=color:#f1fa8c>}</span> --key <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>key_file</span><span style=color:#f1fa8c>}</span> --cert <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>cert_file</span><span style=color:#f1fa8c>}</span> -n <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>namespace</span><span style=color:#f1fa8c>}</span>
</span></span></code></pre></div><ol start=3><li>And then we create a Ingress out of it for a <code>component</code> on <code>targetPort</code>
expose as ${host} (for example for a docker registry, I use <code>docker-registry</code>
as component, <code>5000</code> as <code>targetPort</code> and <code>host</code> as <code>registry.local</code> which
resolve via my local DNS but you can use a <code>/etc/host</code> entry too)</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#f1fa8c>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>---
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>apiVersion: networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>kind: Ingress
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>metadata:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  name: &#34;${component}&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  namespace: &#34;${namespace}&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>spec:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  ingressClassName: nginx
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  tls:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    - hosts:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        - &#34;${host}&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      secretName: &#34;${sec_name}&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  rules:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    - host: &#34;${host}&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      http:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        paths:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          - pathType: ImplementationSpecific
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            backend:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>              service:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                name: &#34;${component}&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                port:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                  number: ${targetPort}
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>EOF</span>
</span></span></code></pre></div><p>For the docker registries you actually need some other annotations to give to
ingress nginx to let know that large blobs are OK, here is what I do to actually
set those, you don&rsquo;t need to set them if your service don&rsquo;t need to increase the
read/send timeout nginx settings.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>for</span> annotations in <span style=color:#f1fa8c>&#34;nginx.ingress.kubernetes.io/proxy-body-size=0&#34;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span> <span style=color:#f1fa8c>&#34;nginx.ingress.kubernetes.io/proxy-read-timeout=600&#34;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span> <span style=color:#f1fa8c>&#34;nginx.ingress.kubernetes.io/proxy-send-timeout=600&#34;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span> <span style=color:#f1fa8c>&#34;kubernetes.io/tls-acme=true&#34;</span>; <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span> kubectl -v<span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span> annotate ingress -n <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>namespace</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>component</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>annotations</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>done</span>
</span></span></code></pre></div><h2 id=clients>Clients<a hidden class=anchor aria-hidden=true href=#clients>#</a></h2><h3 id=installing-the-certificate-system-wise-linux>Installing the certificate system wise (Linux)<a hidden class=anchor aria-hidden=true href=#installing-the-certificate-system-wise-linux>#</a></h3><h3 id=linux-generic>Linux (generic)<a hidden class=anchor aria-hidden=true href=#linux-generic>#</a></h3><p>On Linux you can install the certificate system wise by issuing this command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>sudo trust anchor -v --store minica/minica.pem
</span></span></code></pre></div><h3 id=nixos>NixOS<a hidden class=anchor aria-hidden=true href=#nixos>#</a></h3><p>On Nix you can simply use the option
<a href="https://search.nixos.org/options?channel=unstable&amp;show=security.pki.certificates&amp;from=0&amp;size=50&amp;sort=relevance&amp;type=packages&amp;query=security.pki.cert">security.pki.cert</a>
and include the certificate in your configuration.</p><h3 id=curl>Curl<a hidden class=anchor aria-hidden=true href=#curl>#</a></h3><p>If you are not installing the certificate system wise you can still use curl with the custom certificate by specifying the cacert argument:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>curl --cacert minica/minica.pem https://<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>host</span><span style=color:#f1fa8c>}</span>
</span></span></code></pre></div><p>and no weird error :)</p><h3 id=firefox>Firefox<a hidden class=anchor aria-hidden=true href=#firefox>#</a></h3><p>For Firefox you open the settings, search <code>view certificates</code> and click it, go
to the <code>Authorities</code> tab click on Import use the <code>minica.pem</code> file as generated in
the <code>minica/</code> directory and trust it as root domain by checking the
checkbox. Now if you go to the https://${host} it should not bring any scary
messages.</p><h3 id=chrome-browsers>Chrome browsers<a hidden class=anchor aria-hidden=true href=#chrome-browsers>#</a></h3><p>Almost the same thing with chrome browser, I use Brave but that should apply to
others. Go to this URL in your browser to see the certificates (it&rsquo;s in the
security section if you look for it from the home settings)</p><p><a href=brave://settings/certificates>brave://settings/certificates</a></p><p>go to the authorities tab and import your <code>minica.pem</code> from the <code>minica/</code>
directory and you should be good to go.</p><h3 id=python-request>Python request<a hidden class=anchor aria-hidden=true href=#python-request>#</a></h3><p>Just for completeness using python requests you can simply specify the root certificates by
using the non obvious keyword verify:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>                r <span style=color:#ff79c6>=</span> requests<span style=color:#ff79c6>.</span>get(
</span></span><span style=display:flex><span>                    <span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;https://</span><span style=color:#f1fa8c>{</span>domain<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/&#34;</span>,
</span></span><span style=display:flex><span>                    verify<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;minica/minica.pem&#34;</span>,
</span></span><span style=display:flex><span>                )
</span></span></code></pre></div><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>There is no reason to don&rsquo;t use SSL domains for your local services on your
cluster and you won&rsquo;t need to spend your precious time clicking on those &ldquo;trust
me&rdquo; button anymore.</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://blog.chmouel.com/>Chmouel's blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>