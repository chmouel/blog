<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Audit a swift cluster | Chmouel's blog</title><meta name=keywords content="Openstack"><meta name=description content="Swift integrity tools.
There is quite a bit of tools shipped with Swift to ensure you have the right object on your cluster.
At first there is the basic :
swift-object-info
It will take a swift object stored on the filesystem and print some infos about it, like this :
 swift@storage01:0/016/0b221bab535ac1b8f0d91e394f225016$ swift-object-info 1327991417.01411.data
Path: /AUTH_root/foobar/file.txt
Account: AUTH_root
Container: foobar
Object: file.txt
Object hash: 0b221bab535ac1b8f0d91e394f225016
Ring locations:
192.168.254.12:6000 - /srv/node/sdb1/objects/0/016/0b221bab535ac1b8f0d91e394f225016/1327991417.01411.data"><meta name=author content><link rel=canonical href=https://blog.chmouel.com/2012/02/01/audit-a-swift-cluster/><link crossorigin=anonymous href=/assets/css/stylesheet.min.f744a7c02fe0f72ec95d2aae501c0293b9cf2f0b780ebc24a8d3ead15bffaae1.css integrity="sha256-90SnwC/g9y7JXSquUBwCk7nPLwt4DrwkqNPq0Vv/quE=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.chmouel.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.chmouel.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.chmouel.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.chmouel.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.chmouel.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Audit a swift cluster"><meta property="og:description" content="Swift integrity tools.
There is quite a bit of tools shipped with Swift to ensure you have the right object on your cluster.
At first there is the basic :
swift-object-info
It will take a swift object stored on the filesystem and print some infos about it, like this :
 swift@storage01:0/016/0b221bab535ac1b8f0d91e394f225016$ swift-object-info 1327991417.01411.data
Path: /AUTH_root/foobar/file.txt
Account: AUTH_root
Container: foobar
Object: file.txt
Object hash: 0b221bab535ac1b8f0d91e394f225016
Ring locations:
192.168.254.12:6000 - /srv/node/sdb1/objects/0/016/0b221bab535ac1b8f0d91e394f225016/1327991417.01411.data"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.chmouel.com/2012/02/01/audit-a-swift-cluster/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2012-02-01T10:18:11+00:00"><meta property="article:modified_time" content="2012-02-01T10:18:11+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Audit a swift cluster"><meta name=twitter:description content="Swift integrity tools.
There is quite a bit of tools shipped with Swift to ensure you have the right object on your cluster.
At first there is the basic :
swift-object-info
It will take a swift object stored on the filesystem and print some infos about it, like this :
 swift@storage01:0/016/0b221bab535ac1b8f0d91e394f225016$ swift-object-info 1327991417.01411.data
Path: /AUTH_root/foobar/file.txt
Account: AUTH_root
Container: foobar
Object: file.txt
Object hash: 0b221bab535ac1b8f0d91e394f225016
Ring locations:
192.168.254.12:6000 - /srv/node/sdb1/objects/0/016/0b221bab535ac1b8f0d91e394f225016/1327991417.01411.data"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.chmouel.com/posts/"},{"@type":"ListItem","position":2,"name":"Audit a swift cluster","item":"https://blog.chmouel.com/2012/02/01/audit-a-swift-cluster/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Audit a swift cluster","name":"Audit a swift cluster","description":"Swift integrity tools.\nThere is quite a bit of tools shipped with Swift to ensure you have the right object on your cluster.\nAt first there is the basic :\nswift-object-info\nIt will take a swift object stored on the filesystem and print some infos about it, like this :\n swift@storage01:0/016/0b221bab535ac1b8f0d91e394f225016$ swift-object-info 1327991417.01411.data\nPath: /AUTH_root/foobar/file.txt\nAccount: AUTH_root\nContainer: foobar\nObject: file.txt\nObject hash: 0b221bab535ac1b8f0d91e394f225016\nRing locations:\n192.168.254.12:6000 - /srv/node/sdb1/objects/0/016/0b221bab535ac1b8f0d91e394f225016/1327991417.01411.data","keywords":["Openstack"],"articleBody":"Swift integrity tools.\nThere is quite a bit of tools shipped with Swift to ensure you have the right object on your cluster.\nAt first there is the basic :\nswift-object-info\nIt will take a swift object stored on the filesystem and print some infos about it, like this :\n swift@storage01:0/016/0b221bab535ac1b8f0d91e394f225016$ swift-object-info 1327991417.01411.data\nPath: /AUTH_root/foobar/file.txt\nAccount: AUTH_root\nContainer: foobar\nObject: file.txt\nObject hash: 0b221bab535ac1b8f0d91e394f225016\nRing locations:\n192.168.254.12:6000 - /srv/node/sdb1/objects/0/016/0b221bab535ac1b8f0d91e394f225016/1327991417.01411.data\nContent-Type: text/plain\nTimestamp: 2012-01-31 06:30:17.014110 (1327991417.01411)\nETag: 053a0f8516a5023b9af76c49ca917d3e (valid)\nContent-Length: 24 (valid)\nUser Metadata: {‘X-Object-Meta-Mtime’: ‘1327968327.21’}\n PS: If you don’t know where is your object on which node, you can you use swift-get-nodes\nFor auditing, the Etag value is important because swift-object-info will compare the object recorded etag in the metadata with what we have on the disks. Let’s try to see if that works :\n swift@storage01:0/016/0b221bab535ac1b8f0d91e394f225016$ cp 1327991417.01411.data /tmp\nswift@storage01:0/016/0b221bab535ac1b8f0d91e394f225016$ echo “foo” » 1327991417.01411.data\nswift@storage01:0/016/0b221bab535ac1b8f0d91e394f225016$ swift-object-info 1327991417.01411.data|grep ‘^Etag’\nEtag: 053a0f8516a5023b9af76c49ca917d3e doesn’t match file hash of 9ff871e5ce5dcb5d3f2680a80a88ff38!\n swift-object-info has detected that this file is not the one we have uploaded.\nThere is an other tool called swift-drive-audit which as explained in the admin guide will parse the /var/log/kern.log and have predefined regexp to detect disk failure notified by the kernel. It is usually run periodically by cron and there is a config file for it called /etc/swift/drive-audit.conf. If the script find any errors for a certain drive it will unmount it and comment it in /etc/fstab(5). Afterwards the replication process will pick it up from other replicas and put the object on that drive in handover.\nSwift provide as well different type of auditor daemons for account/container/object :\n  swift-account-auditor  swift-container-auditor  swift-object-auditor  swift-account-auditor will open all sqlite db of an account server and launch a SQL query to make sure all the dbs are valid.\nswift-container-auditor will do the same but for containers.\nswift-object-auditor will open all object of an object server and make sure of :\n Metadata are correct. We have the proper size. We have the proper MD5.  Those auditors needs to be set in each type-server.conf, for example for account server you will add something like this to /etc/swift/account-server.conf :\n [account-auditor]\n# You can override the default log routing for this app here (don’t use set!):\n# log_name = account-auditor\n# log_facility = LOG_LOCAL0\n# log_level = INFO\n# Will audit, at most, 1 account per device per interval\ninterval = 1800\n# log_facility = LOG_LOCAL0\n# log_level = INFO\n For container this is about the same options but for object-server does are the options :\n [object-auditor]\n# You can override the default log routing for this app here (don’t use set!):\n# log_name = object-auditor\n# log_facility = LOG_LOCAL0\n# log_level = INFO\n# files_per_second = 20\n# bytes_per_second = 10000000\n# log_time = 3600\n# zero_byte_files_per_second = 50\n Another tool shipped with swift is swift-account-audit which will audit a full account and report if there is missing replicas or incorrect object in that account.\n","wordCount":"487","inLanguage":"en","datePublished":"2012-02-01T10:18:11Z","dateModified":"2012-02-01T10:18:11Z","author":{"@type":"Person","name":"chmouel"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.chmouel.com/2012/02/01/audit-a-swift-cluster/"},"publisher":{"@type":"Organization","name":"Chmouel's blog","logo":{"@type":"ImageObject","url":"https://blog.chmouel.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.chmouel.com/ accesskey=h title="Chmouel's blog (Alt + H)">Chmouel's blog</a>
<span class=logo-switches></span></div><ul id=menu><li><a href=https://github.com/chmouel/ title=Github><span>Github</span></a></li><li><a href=https://photos.chmouel.com title=Photos><span>Photos</span></a></li><li><a href=https://app.strava.com/athletes/126695 title=Strava><span>Strava</span></a></li><li><a href=https://twitter.com/chmouel title=Twitter><span>Twitter</span></a></li><li><a href=https://redhat.com title=Work><span>Work</span></a></li><li><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Audit a swift cluster</h1><div class=post-meta><span title="2012-02-01 10:18:11 +0000 UTC">February 1, 2012</span>&nbsp;|&nbsp;<a href=https://github.com/chmouel/blog/tree/main/content/posts/2012-02-01-audit-a-swift-cluster.md rel="noopener noreferrer" target=_blank>Edit</a></div></header><div class=post-content><p>Swift integrity tools.</p><p>There is quite a bit of tools shipped with Swift to ensure you have the right object on your cluster.</p><p>At first there is the basic :</p><p><strong>swift-object-info</strong></p><p>It will take a swift object stored on the filesystem and print some infos about it, like this :</p><blockquote><p>swift@storage01:0/016/0b221bab535ac1b8f0d91e394f225016$ swift-object-info 1327991417.01411.data<br>Path: /AUTH_root/foobar/file.txt<br>Account: AUTH_root<br>Container: foobar<br>Object: file.txt<br>Object hash: 0b221bab535ac1b8f0d91e394f225016<br>Ring locations:<br>192.168.254.12:6000 - /srv/node/sdb1/objects/0/016/0b221bab535ac1b8f0d91e394f225016/1327991417.01411.data<br>Content-Type: text/plain<br>Timestamp: 2012-01-31 06:30:17.014110 (1327991417.01411)<br>ETag: 053a0f8516a5023b9af76c49ca917d3e (valid)<br>Content-Length: 24 (valid)<br>User Metadata: {&lsquo;X-Object-Meta-Mtime&rsquo;: &lsquo;1327968327.21&rsquo;}</p></blockquote><p>PS: If you don&rsquo;t know where is your object on which node, you can you use swift-get-nodes</p><p>For auditing, the Etag value is important because swift-object-info will compare the object recorded etag in the metadata with what we have on the disks. Let&rsquo;s try to see if that works :</p><blockquote><p>swift@storage01:0/016/0b221bab535ac1b8f0d91e394f225016$ cp 1327991417.01411.data /tmp<br>swift@storage01:0/016/0b221bab535ac1b8f0d91e394f225016$ echo &ldquo;foo&rdquo; &#187; 1327991417.01411.data<br>swift@storage01:0/016/0b221bab535ac1b8f0d91e394f225016$ swift-object-info 1327991417.01411.data|grep &lsquo;^Etag&rsquo;<br>Etag: 053a0f8516a5023b9af76c49ca917d3e doesn&rsquo;t match file hash of 9ff871e5ce5dcb5d3f2680a80a88ff38!</p></blockquote><p>swift-object-info has detected that this file is not the one we have uploaded.</p><p>There is an other tool called <strong>swift-drive-audit</strong> which as explained in the <a href=http://swift.openstack.org/admin_guide.html title="Admin Guide">admin guide</a> will parse the <em>/var/log/kern.log</em> and have predefined regexp  to detect disk failure notified by the kernel. It is usually run periodically by cron and there is a config file for it called <em><a href=https://github.com/openstack/swift/blob/master/etc/drive-audit.conf-sample>/etc/swift/drive-audit.conf.</a></em> If the script find any errors for a certain drive it will unmount it and comment it in /etc/fstab(5). Afterwards  the replication process will pick it up from other replicas and put the object on that drive in <em>handover</em>.</p><p>Swift provide as well different type of auditor daemons for account/container/object :</p><ul><li> swift-account-auditor</li><li> swift-container-auditor</li><li> swift-object-auditor</li></ul><p><strong>swift-account-auditor</strong> will open all sqlite db of an account server and launch a SQL query to make sure all the dbs are valid.<br><strong>swift-container-auditor</strong> will do the same but for containers.<br><strong>swift-object-auditor</strong> will open all object of an object server and make sure of :</p><ul><li>Metadata are correct.</li><li>We have the proper size.</li><li>We have the proper MD5.</li></ul><p>Those auditors needs to be set in each type-server.conf, for example for account server you will add something like this to /etc/swift/account-server.conf :</p><blockquote><p>[account-auditor]<br># You can override the default log routing for this app here (don&rsquo;t use set!):<br># log_name = account-auditor<br># log_facility = LOG_LOCAL0<br># log_level = INFO<br># Will audit, at most, 1 account per device per interval<br>interval = 1800<br># log_facility = LOG_LOCAL0<br># log_level = INFO</p></blockquote><p>For container this is about the same options but for object-server does are the options :</p><blockquote><p>[object-auditor]<br># You can override the default log routing for this app here (don&rsquo;t use set!):<br># log_name = object-auditor<br># log_facility = LOG_LOCAL0<br># log_level = INFO<br># files_per_second = 20<br># bytes_per_second = 10000000<br># log_time = 3600<br># zero_byte_files_per_second = 50</p></blockquote><p>Another tool shipped with swift is <strong>swift-account-audit</strong> which will audit a full account and report if there is missing replicas or incorrect object in that account.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.chmouel.com/tags/openstack/>Openstack</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://blog.chmouel.com/>Chmouel's blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>